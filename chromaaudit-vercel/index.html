<!DOCTYPE html>
<html lang="es">
<head>
    <title>ChromaAudit — Color Accessibility & Fuzzy Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d0d0f;
            --panel: #16161a;
            --border: rgba(255,255,255,0.07);
            --accent: #b0ff4b;
            --accent2: #4bffec;
            --text: #e8e8e8;
            --muted: #666;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Syne', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 2rem 1rem 3rem;
        }

        /* ── HEADER ── */
        header {
            width: 100%;
            max-width: 900px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        header .logo {
            font-family: 'Space Mono', monospace;
            font-size: 0.72rem;
            color: var(--muted);
            line-height: 1.7;
        }
        header .badge {
            background: var(--accent);
            color: #0d0d0f;
            font-size: 0.68rem;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            padding: 0.3rem 0.8rem;
            border-radius: 99px;
            letter-spacing: 0.05em;
        }

        /* ── CARD PRINCIPAL ── */
        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2.5rem;
            width: 100%;
            max-width: 900px;
            margin-bottom: 1.5rem;
        }

        /* Fila selector + preview */
        .row-top {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* ── SELECTOR ── */
        .picker-wrap h2 {
            font-size: 0.72rem;
            font-family: 'Space Mono', monospace;
            color: var(--muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        #color-input {
            width: 100%;
            height: 56px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: transparent;
            cursor: pointer;
            padding: 2px;
            margin-bottom: 1rem;
        }
        #color-input::-webkit-color-swatch-wrapper { padding: 0; }
        #color-input::-webkit-color-swatch { border-radius: 10px; border: none; }

        .hex-display {
            font-family: 'Space Mono', monospace;
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: 0.04em;
        }
        .rgb-display {
            font-family: 'Space Mono', monospace;
            font-size: 0.78rem;
            color: var(--muted);
            margin-top: 0.3rem;
        }

        /* ── PREVIEW DIV ── */
        .preview-wrap h2 {
            font-size: 0.72rem;
            font-family: 'Space Mono', monospace;
            color: var(--muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        #sitio {
            width: 100%;
            height: 130px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Syne', sans-serif;
            font-size: 1.05rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            text-align: center;
            padding: 1rem 1.5rem;
            transition: background 0.3s ease, color 0.25s ease;
            border: 2px solid rgba(255,255,255,0.08);
            line-height: 1.4;
        }
        #sitio small {
            font-weight: 400;
            font-size: 0.62rem;
            opacity: 0.7;
            font-family: 'Space Mono', monospace;
            margin-top: 0.3rem;
            letter-spacing: 0.06em;
        }

        /* ── BARRA DE ESCALA DIFUSA ── */
        .scale-section h2 {
            font-size: 0.72rem;
            font-family: 'Space Mono', monospace;
            color: var(--muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .fuzzy-scale {
            position: relative;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(to right,
                #000000, #111111, #222222, #333333, #444444,
                #555555, #666666, #777777, #888888, #999999,
                #aaaaaa, #bbbbbb, #cccccc, #dddddd, #eeeeee, #ffffff
            );
            margin-bottom: 0.6rem;
            overflow: hidden;
        }

        #scale-marker {
            position: absolute;
            top: 0; bottom: 0;
            width: 4px;
            border-radius: 4px;
            background: var(--accent);
            transform: translateX(-50%);
            transition: left 0.3s ease;
            box-shadow: 0 0 10px var(--accent);
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            font-family: 'Space Mono', monospace;
            font-size: 0.62rem;
            color: var(--muted);
        }

        /* ── CONJUNTOS DIFUSOS ── */
        .sets-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .set-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1rem 1.2rem;
        }
        .set-card h3 {
            font-size: 0.65rem;
            font-family: 'Space Mono', monospace;
            color: var(--muted);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 0.7rem;
        }
        .set-name {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text);
        }
        .bar-track {
            height: 8px;
            background: rgba(255,255,255,0.06);
            border-radius: 99px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            border-radius: 99px;
            transition: width 0.35s ease, background 0.35s ease;
        }
        .membership-val {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--muted);
            margin-top: 0.4rem;
        }

        /* ── TABLA DE INFERENCIA ── */
        .inference-section {
            margin-top: 1.5rem;
        }
        .inference-section h2 {
            font-size: 0.72rem;
            font-family: 'Space Mono', monospace;
            color: var(--muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 0.6rem;
        }
        .rule {
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.7rem 1rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: border-color 0.3s, background 0.3s;
        }
        .rule.active {
            border-color: var(--accent);
            background: rgba(176,255,75,0.05);
            color: var(--accent);
        }
        .rule-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--muted);
            flex-shrink: 0;
            transition: background 0.3s;
        }
        .rule.active .rule-dot { background: var(--accent); }

        /* ── OUTPUT DIFUSO ── */
        .output-section {
            margin-top: 1.5rem;
            display: flex;
            gap: 1.5rem;
            align-items: stretch;
        }
        .output-verdict {
            flex: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.2rem 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .output-verdict h3 {
            font-size: 0.65rem;
            font-family: 'Space Mono', monospace;
            color: var(--muted);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 0.6rem;
        }
        #verdict-text {
            font-size: 1.5rem;
            font-weight: 800;
            transition: color 0.3s;
        }
        #verdict-sub {
            font-family: 'Space Mono', monospace;
            font-size: 0.66rem;
            color: var(--muted);
            margin-top: 0.3rem;
        }

        .output-crisp {
            flex: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.2rem 1.5rem;
        }
        .output-crisp h3 {
            font-size: 0.65rem;
            font-family: 'Space Mono', monospace;
            color: var(--muted);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 0.6rem;
        }
        .crisp-val {
            font-family: 'Space Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }
        .crisp-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.66rem;
            color: var(--muted);
            margin-top: 0.3rem;
        }

        /* ── NEURONAL vs DIFUSA BADGE ── */
        .method-badge {
            display: inline-flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .mbadge {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            padding: 0.25rem 0.7rem;
            border-radius: 99px;
            border: 1px solid var(--border);
            color: var(--muted);
        }
        .mbadge.on {
            border-color: var(--accent2);
            color: var(--accent2);
            background: rgba(75,255,236,0.06);
        }

        /* ── CANVAS VISUALIZACIÓN CONJUNTOS ── */
        canvas {
            width: 100%;
            height: 90px;
            border-radius: 10px;
            display: block;
            margin-top: 0.5rem;
        }

        /* ── FOOTER ── */
        footer {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            text-align: center;
            margin-top: 1rem;
        }

        @media(max-width: 640px){
            .row-top { grid-template-columns: 1fr; }
            .sets-row { grid-template-columns: 1fr; }
            .output-section { flex-direction: column; }
        }

        /* ═══════════════════════════════════════════════════
           PUNTO 1 — AUDITORÍA WCAG AA / AAA 
        ═══════════════════════════════════════════════════ */

        .wcag-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2.5rem;
            width: 100%;
            max-width: 900px;
            margin-bottom: 1.5rem;
        }

        .wcag-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .wcag-header-left h2 {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text);
            letter-spacing: -0.01em;
        }
        .wcag-header-left p {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            margin-top: 0.3rem;
        }

        /* Badges de nivel */
        .level-legend {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .lvl-badge {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 0.25rem 0.65rem;
            border-radius: 99px;
            letter-spacing: 0.06em;
        }
        .lvl-fail { background: rgba(255,75,75,0.15);  color: #ff4b4b; border: 1px solid rgba(255,75,75,0.3); }
        .lvl-aa   { background: rgba(255,204,0,0.12);  color: #ffcc00; border: 1px solid rgba(255,204,0,0.3); }
        .lvl-aaa  { background: rgba(176,255,75,0.12); color: #b0ff4b; border: 1px solid rgba(176,255,75,0.3); }

        /* ── PALETA DE ENTRADA ── */
        .palette-input-section {
            margin-bottom: 2rem;
        }
        .palette-input-section h3 {
            font-family: 'Space Mono', monospace;
            font-size: 0.68rem;
            color: var(--muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .palette-slots {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .color-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }
        .color-slot:hover .palette-swatch-clickable {
            transform: scale(1.08) !important;
            border-color: rgba(176,255,75,0.4) !important;
        }

        /* ── COLOR PICKER CUSTOM ── */
        .custom-color-picker {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            min-width: 260px;
        }
        .custom-color-picker.visible {
            display: block;
            animation: pickerFadeIn 0.2s ease;
        }
        @keyframes pickerFadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        .picker-title {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .picker-close {
            background: transparent;
            border: none;
            color: var(--muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s, color 0.2s;
        }
        .picker-close:hover {
            background: rgba(255,75,75,0.1);
            color: #ff4b4b;
        }

        .picker-preview {
            width: 100%;
            height: 60px;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .picker-sliders {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            margin-bottom: 0.75rem;
        }
        .picker-slider-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .picker-slider-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--text);
            width: 20px;
        }
        .picker-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            outline: none;
        }
        .picker-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--text);
            cursor: pointer;
            border: 2px solid var(--panel);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .picker-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--text);
            cursor: pointer;
            border: 2px solid var(--panel);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .picker-slider-value {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            width: 35px;
            text-align: right;
        }

        .picker-hex-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .picker-hex-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
        }
        .picker-hex-input {
            flex: 1;
            padding: 0.4rem 0.6rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            outline: none;
            text-align: center;
        }
        .picker-hex-input:focus {
            border-color: var(--accent);
        }

        .picker-presets {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }
        .picker-presets-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .picker-presets-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.4rem;
        }
        .picker-preset-swatch {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.15s, border-color 0.15s;
        }
        .picker-preset-swatch:hover {
            transform: scale(1.1);
            border-color: var(--accent);
        }

        /* Overlay para cerrar al hacer clic fuera */
        .picker-overlay {
            position: fixed;
            inset: 0;
            background: transparent;
            z-index: 999;
            display: none;
        }
        .picker-overlay.visible {
            display: block;
        }

        .btn-add-color {
            width: 52px; height: 52px;
            border-radius: 12px;
            border: 2px dashed rgba(255,255,255,0.15);
            background: transparent;
            color: var(--muted);
            font-size: 1.4rem;
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-add-color:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* ── MATRIZ DE CONTRASTE ── */
        .contrast-matrix-wrap {
            overflow-x: auto;
            margin-bottom: 2rem;
        }
        .contrast-matrix-wrap h3 {
            font-family: 'Space Mono', monospace;
            font-size: 0.68rem;
            color: var(--muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .contrast-matrix {
            border-collapse: collapse;
            width: 100%;
            min-width: 400px;
        }
        .contrast-matrix th {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--muted);
            padding: 0.5rem 0.7rem;
            text-align: center;
            font-weight: 400;
            border: 1px solid var(--border);
        }
        .contrast-matrix td {
            padding: 0;
            border: 1px solid var(--border);
            width: 90px;
            height: 70px;
        }

        /* Celda de la matriz */
        .matrix-cell {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 0.4rem;
            font-family: 'Space Mono', monospace;
            transition: transform 0.15s;
            cursor: default;
            position: relative;
        }
        .matrix-cell:hover { transform: scale(1.05); z-index: 2; }

        .matrix-cell.same-color {
            background: repeating-linear-gradient(
                45deg,
                rgba(255,255,255,0.02),
                rgba(255,255,255,0.02) 4px,
                transparent 4px,
                transparent 10px
            );
        }

        .cell-ratio {
            font-size: 0.72rem;
            font-weight: 700;
            line-height: 1;
        }
        .cell-levels {
            display: flex;
            gap: 2px;
            margin-top: 2px;
        }
        .cell-pip {
            font-size: 0.48rem;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 700;
            letter-spacing: 0.04em;
        }
        .pip-fail { background: rgba(255,75,75,0.25);  color: #ff4b4b; }
        .pip-aa   { background: rgba(255,204,0,0.25);  color: #ffcc00; }
        .pip-aaa  { background: rgba(176,255,75,0.25); color: #b0ff4b; }

        /* Encabezado de fila (color de fondo) */
        .matrix-row-header {
            width: 70px;
            height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-family: 'Space Mono', monospace;
        }
        .row-swatch {
            width: 32px; height: 32px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .row-hex-label {
            font-size: 0.48rem;
            color: var(--muted);
        }

        /* ── REPORTE DETALLADO ── */
        .wcag-report {
            margin-top: 0.5rem;
        }
        .wcag-report h3 {
            font-family: 'Space Mono', monospace;
            font-size: 0.68rem;
            color: var(--muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .report-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .report-row {
            display: grid;
            grid-template-columns: 80px 80px 1fr auto auto;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.65rem 1rem;
            transition: border-color 0.2s;
        }
        .report-row:hover { border-color: rgba(255,255,255,0.15); }

        .report-swatch-pair {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .report-swatch {
            width: 28px; height: 28px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }
        .report-preview {
            border-radius: 6px;
            padding: 0.3rem 0.6rem;
            font-family: 'Syne', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 160px;
        }
        .report-ratio {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text);
            text-align: center;
        }
        .report-levels {
            display: flex;
            gap: 0.3rem;
        }
        .report-verdict {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            text-align: right;
            color: var(--muted);
        }

        /* ── STATS SUMMARY ── */
        .wcag-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 2rem;
        }
        .stat-box {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }
        .stat-number {
            font-family: 'Space Mono', monospace;
            font-size: 1.6rem;
            font-weight: 700;
            line-height: 1;
        }
        .stat-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.58rem;
            color: var(--muted);
            margin-top: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        @media(max-width: 640px){
            .report-row { grid-template-columns: 60px 60px 1fr; }
            .report-levels, .report-verdict { grid-column: span 3; }
            .wcag-stats { grid-template-columns: repeat(2,1fr); }
        }

        /* ═══════════════════════════════════════════════════
           PUNTO 2 — INPUT DEL MUNDO REAL
           URL Scanner + Imagen/Logo → Paleta automática
        ═══════════════════════════════════════════════════ */

        .input-real-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2.5rem;
            width: 100%;
            max-width: 900px;
            margin-bottom: 1.5rem;
        }
        .input-real-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .input-real-header h2 {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text);
        }
        .input-real-header p {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            margin-top: 0.3rem;
        }

        /* ── TABS ── */
        .ir-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0;
        }
        .ir-tab {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.6rem 1.2rem;
            border-radius: 10px 10px 0 0;
            border: 1px solid transparent;
            border-bottom: none;
            cursor: pointer;
            color: var(--muted);
            background: transparent;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            transition: color 0.2s, background 0.2s, border-color 0.2s;
            position: relative;
            bottom: -1px;
        }
        .ir-tab.active {
            color: var(--accent);
            background: var(--panel);
            border-color: var(--border);
            border-bottom-color: var(--panel);
        }
        .ir-tab:hover:not(.active) { color: var(--text); }

        .ir-panel { display: none; }
        .ir-panel.active { display: block; }

        /* ── URL SCANNER ── */
        .url-form {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .url-input {
            flex: 1;
            min-width: 220px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.75rem 1.1rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.78rem;
            color: var(--text);
            outline: none;
            transition: border-color 0.2s;
        }
        .url-input::placeholder { color: var(--muted); }
        .url-input:focus { border-color: rgba(176,255,75,0.4); }

        .btn-scan {
            background: var(--accent);
            color: #0d0d0f;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.72rem;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.06em;
            transition: opacity 0.2s, transform 0.15s;
            white-space: nowrap;
        }
        .btn-scan:hover { opacity: 0.88; transform: translateY(-1px); }
        .btn-scan:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        /* Estado del scanner */
        .scan-status {
            font-family: 'Space Mono', monospace;
            font-size: 0.68rem;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        .scan-status.loading {
            display: block;
            color: var(--accent2);
            background: rgba(75,255,236,0.07);
            border: 1px solid rgba(75,255,236,0.2);
        }
        .scan-status.success {
            display: block;
            color: var(--accent);
            background: rgba(176,255,75,0.07);
            border: 1px solid rgba(176,255,75,0.2);
        }
        .scan-status.error {
            display: block;
            color: #ff4b4b;
            background: rgba(255,75,75,0.07);
            border: 1px solid rgba(255,75,75,0.2);
        }

        /* Spinner */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            display: inline-block;
            width: 10px; height: 10px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }

        /* Nota sobre CORS */
        .cors-note {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--muted);
            margin-bottom: 1.5rem;
            padding: 0.6rem 0.9rem;
            background: rgba(255,255,255,0.02);
            border-left: 2px solid rgba(255,255,255,0.1);
            border-radius: 0 6px 6px 0;
            line-height: 1.7;
        }

        /* ── IMAGEN / LOGO ── */
        .drop-zone {
            border: 2px dashed rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            position: relative;
            margin-bottom: 1.5rem;
        }
        .drop-zone.dragover {
            border-color: var(--accent);
            background: rgba(176,255,75,0.04);
        }
        .drop-zone input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        .drop-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            display: block;
        }
        .drop-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.72rem;
            color: var(--muted);
            line-height: 1.7;
        }
        .drop-label strong { color: var(--text); }

        /* Canvas de imagen previa + muestras */
        .image-analysis-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }
        .image-preview-wrap {
            border-radius: 12px;
            overflow: hidden;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 160px;
        }
        #image-preview-canvas {
            max-width: 100%;
            max-height: 200px;
            display: block;
            border-radius: 10px;
        }
        .extracted-colors-wrap {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .extracted-colors-wrap h4 {
            font-family: 'Space Mono', monospace;
            font-size: 0.62rem;
            color: var(--muted);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        .extracted-swatches {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .ext-swatch {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            cursor: pointer;
            transition: transform 0.15s;
        }
        .ext-swatch:hover { transform: scale(1.1); }
        .ext-swatch-color {
            width: 44px; height: 44px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.1);
            transition: border-color 0.2s;
        }
        .ext-swatch.selected .ext-swatch-color {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(176,255,75,0.3);
        }
        .ext-swatch-hex {
            font-family: 'Space Mono', monospace;
            font-size: 0.48rem;
            color: var(--muted);
        }
        .ext-swatch-pct {
            font-family: 'Space Mono', monospace;
            font-size: 0.44rem;
            color: rgba(255,255,255,0.3);
        }

        /* Slider cantidad colores */
        .color-count-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .color-count-row label {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            white-space: nowrap;
        }
        .color-count-row input[type="range"] {
            flex: 1;
            accent-color: var(--accent);
        }
        .color-count-val {
            font-family: 'Space Mono', monospace;
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--accent);
            width: 20px;
            text-align: center;
        }

        /* Botón "Enviar al auditor" */
        .btn-inject {
            background: transparent;
            color: var(--accent);
            border: 1px solid rgba(176,255,75,0.4);
            border-radius: 10px;
            padding: 0.65rem 1.3rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.06em;
            transition: background 0.2s, color 0.2s;
            margin-top: 0.5rem;
        }
        .btn-inject:hover {
            background: rgba(176,255,75,0.1);
        }
        .btn-inject:disabled { opacity: 0.3; cursor: not-allowed; }

        @media(max-width: 640px){
            .image-analysis-row { grid-template-columns: 1fr; }
            .url-form { flex-direction: column; }
        }

        /* ═══════════════════════════════════════════════════
           PUNTO 3 — OUTPUT ACCIONABLE
           CSS · Tailwind · Figma · JSON → copiar/descargar
        ═══════════════════════════════════════════════════ */

        .output-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2.5rem;
            width: 100%;
            max-width: 900px;
            margin-bottom: 1.5rem;
        }
        .output-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .output-header h2 {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text);
        }
        .output-header p {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            margin-top: 0.3rem;
        }

        /* Tabs de export */
        .export-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0;
            flex-wrap: wrap;
        }
        .export-tab {
            font-family: 'Space Mono', monospace;
            font-size: 0.68rem;
            font-weight: 700;
            padding: 0.55rem 1.1rem;
            border-radius: 10px 10px 0 0;
            border: 1px solid transparent;
            border-bottom: none;
            cursor: pointer;
            color: var(--muted);
            background: transparent;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            transition: color 0.2s, background 0.2s, border-color 0.2s;
            position: relative;
            bottom: -1px;
            white-space: nowrap;
        }
        .export-tab.active {
            color: var(--accent);
            background: var(--panel);
            border-color: var(--border);
            border-bottom-color: var(--panel);
        }
        .export-tab:hover:not(.active) { color: var(--text); }

        .export-panel { display: none; }
        .export-panel.active { display: block; }

        /* Code block */
        .code-block {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            max-height: 400px;
            overflow-y: auto;
        }
        .code-block pre {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            line-height: 1.65;
            color: #e8e8e8;
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .code-block code {
            font-family: inherit;
        }

        /* Syntax highlighting simple */
        .code-key    { color: #4bffec; }
        .code-string { color: #b0ff4b; }
        .code-number { color: #ffcc00; }
        .code-comment{ color: #666; }
        .code-punct  { color: #999; }

        /* Botones de acción */
        .code-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .btn-copy, .btn-download {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.65rem 1.3rem;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            letter-spacing: 0.06em;
            transition: opacity 0.2s, transform 0.15s, background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-copy {
            background: transparent;
            color: var(--accent2);
            border: 1px solid rgba(75,255,236,0.4);
        }
        .btn-copy:hover {
            background: rgba(75,255,236,0.1);
        }
        .btn-copy.copied {
            background: rgba(75,255,236,0.15);
            color: var(--accent);
            border-color: var(--accent);
        }
        .btn-download {
            background: var(--accent);
            color: #0d0d0f;
        }
        .btn-download:hover {
            opacity: 0.88;
            transform: translateY(-1px);
        }

        /* Estado vacío */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
            font-size: 0.72rem;
            line-height: 1.8;
        }
        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            display: block;
            opacity: 0.4;
        }

        /* Descripción de cada formato */
        .format-desc {
            font-family: 'Space Mono', monospace;
            font-size: 0.62rem;
            color: var(--muted);
            margin-bottom: 1rem;
            padding: 0.6rem 0.9rem;
            background: rgba(255,255,255,0.02);
            border-left: 2px solid rgba(176,255,75,0.2);
            border-radius: 0 6px 6px 0;
            line-height: 1.7;
        }
        .format-desc strong { color: var(--text); }

        @media(max-width: 640px){
            .export-tabs { justify-content: flex-start; }
            .code-actions { flex-direction: column; }
            .btn-copy, .btn-download { width: 100%; justify-content: center; }
        }

        /* ═══════════════════════════════════════════════════
           PUNTO 4 — MEMORIA Y COMPARACIÓN
           Historial de paletas + comparador lado a lado
        ═══════════════════════════════════════════════════ */

        .history-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2.5rem;
            width: 100%;
            max-width: 900px;
            margin-bottom: 1.5rem;
        }
        .history-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .history-header h2 {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text);
        }
        .history-header p {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            margin-top: 0.3rem;
        }

        /* Controles de guardado */
        .save-controls {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .palette-name-input {
            flex: 1;
            min-width: 200px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.7rem 1rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--text);
            outline: none;
            transition: border-color 0.2s;
        }
        .palette-name-input::placeholder { color: var(--muted); }
        .palette-name-input:focus { border-color: rgba(176,255,75,0.4); }

        .btn-save {
            background: var(--accent);
            color: #0d0d0f;
            border: none;
            border-radius: 10px;
            padding: 0.7rem 1.4rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.06em;
            transition: opacity 0.2s, transform 0.15s;
            white-space: nowrap;
        }
        .btn-save:hover { opacity: 0.88; transform: translateY(-1px); }
        .btn-save:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }

        /* Lista de historial */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }
        .history-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.2rem;
            display: grid;
            grid-template-columns: 1fr auto auto;
            align-items: center;
            gap: 1rem;
            transition: border-color 0.2s, background 0.2s;
        }
        .history-item:hover { border-color: rgba(255,255,255,0.15); }
        .history-item.selected {
            background: rgba(176,255,75,0.05);
            border-color: rgba(176,255,75,0.3);
        }

        .history-info {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        .history-name {
            font-size: 0.82rem;
            font-weight: 700;
            color: var(--text);
        }
        .history-meta {
            font-family: 'Space Mono', monospace;
            font-size: 0.58rem;
            color: var(--muted);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .history-swatches {
            display: flex;
            gap: 3px;
        }
        .history-swatch {
            width: 22px; height: 22px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .history-actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn-history {
            font-family: 'Space Mono', monospace;
            font-size: 0.62rem;
            font-weight: 700;
            padding: 0.45rem 0.9rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s, background 0.2s;
            white-space: nowrap;
        }
        .btn-history:hover {
            color: var(--text);
            border-color: rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.03);
        }
        .btn-history.danger:hover {
            color: #ff4b4b;
            border-color: rgba(255,75,75,0.4);
            background: rgba(255,75,75,0.05);
        }

        /* Comparador */
        .compare-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }
        .compare-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .compare-header h3 {
            font-family: 'Space Mono', monospace;
            font-size: 0.72rem;
            color: var(--muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }
        .btn-compare {
            background: transparent;
            color: var(--accent2);
            border: 1px solid rgba(75,255,236,0.4);
            border-radius: 10px;
            padding: 0.55rem 1.2rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.68rem;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.06em;
            transition: background 0.2s, color 0.2s;
        }
        .btn-compare:hover { background: rgba(75,255,236,0.1); }
        .btn-compare:disabled { opacity: 0.3; cursor: not-allowed; }

        .compare-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        .compare-col {
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.2rem;
        }
        .compare-col h4 {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }
        .compare-name {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.7rem;
        }
        .compare-swatches {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-bottom: 1rem;
        }
        .compare-stat {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--muted);
            margin-top: 0.4rem;
        }
        .compare-stat strong {
            color: var(--text);
            font-size: 0.7rem;
        }

        .compare-diff {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: 10px;
        }
        .compare-diff h4 {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 0.8rem;
        }
        .diff-row {
            font-family: 'Space Mono', monospace;
            font-size: 0.62rem;
            padding: 0.4rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .diff-row:last-child { border-bottom: none; }
        .diff-improve { color: var(--accent); }
        .diff-worse   { color: #ff4b4b; }
        .diff-same    { color: var(--muted); }

        /* Empty state */
        .history-empty {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            line-height: 1.8;
        }

        @media(max-width: 640px){
            .history-item { grid-template-columns: 1fr; }
            .history-actions { justify-content: flex-start; }
            .compare-grid { grid-template-columns: 1fr; }
            .save-controls { flex-direction: column; }
        }

        /* ═══════════════════════════════════════════════════
           PUNTO 5 — EXPLICACIÓN DIFUSA COMO VENTAJA
           Traducción en lenguaje natural para clientes
        ═══════════════════════════════════════════════════ */

        .explanation-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }
        .explanation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        .explanation-header h3 {
            font-family: 'Space Mono', monospace;
            font-size: 0.72rem;
            color: var(--muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }
        .btn-toggle-explain {
            font-family: 'Space Mono', monospace;
            font-size: 0.62rem;
            font-weight: 700;
            padding: 0.4rem 0.9rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
        }
        .btn-toggle-explain:hover {
            color: var(--accent);
            border-color: rgba(176,255,75,0.3);
        }
        .btn-toggle-explain.active {
            color: var(--accent);
            background: rgba(176,255,75,0.08);
            border-color: rgba(176,255,75,0.3);
        }

        .explanation-box {
            background: rgba(176,255,75,0.04);
            border: 1px solid rgba(176,255,75,0.15);
            border-radius: 12px;
            padding: 1.3rem;
            margin-top: 1rem;
            display: none;
        }
        .explanation-box.visible { display: block; }

        .explain-intro {
            font-family: 'Space Mono', monospace;
            font-size: 0.68rem;
            color: var(--muted);
            margin-bottom: 1rem;
            line-height: 1.7;
        }
        .explain-intro strong { color: var(--text); }

        .explain-decision {
            background: rgba(0,0,0,0.2);
            border-left: 3px solid var(--accent);
            padding: 1rem 1.2rem;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
        }
        .explain-decision-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .explain-decision-body {
            font-family: 'Syne', sans-serif;
            font-size: 0.78rem;
            line-height: 1.7;
            color: var(--text);
        }
        .explain-decision-body ul {
            margin: 0.5rem 0 0 1.2rem;
            padding: 0;
        }
        .explain-decision-body li {
            margin: 0.3rem 0;
        }

        .explain-why {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 0.8rem 1rem;
            margin-top: 0.8rem;
        }
        .explain-why-title {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--accent2);
            letter-spacing: 0.08em;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        .explain-why-text {
            font-size: 0.72rem;
            line-height: 1.65;
            color: rgba(255,255,255,0.8);
        }

        .explain-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        .explain-method {
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
        }
        .explain-method h4 {
            font-family: 'Space Mono', monospace;
            font-size: 0.62rem;
            color: var(--muted);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 0.7rem;
        }
        .explain-method-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.4rem;
        }
        .explain-method-desc {
            font-size: 0.66rem;
            line-height: 1.6;
            color: var(--muted);
        }

        /* Casos especiales destacados */
        .explain-special-case {
            background: linear-gradient(135deg, rgba(255,75,75,0.08), rgba(255,204,0,0.08));
            border: 1px solid rgba(255,75,75,0.2);
            border-radius: 10px;
            padding: 1rem 1.2rem;
            margin-top: 1rem;
        }
        .explain-special-case-title {
            font-family: 'Space Mono', monospace;
            font-size: 0.68rem;
            font-weight: 700;
            color: #ff8c4b;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .explain-special-case-body {
            font-size: 0.72rem;
            line-height: 1.7;
            color: var(--text);
        }

        /* Modo presentación */
        .presentation-mode {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }
        .btn-generate-report {
            width: 100%;
            background: linear-gradient(135deg, var(--accent2), var(--accent));
            color: #0d0d0f;
            border: none;
            border-radius: 12px;
            padding: 0.9rem 1.5rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.06em;
            transition: opacity 0.2s, transform 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.7rem;
        }
        .btn-generate-report:hover {
            opacity: 0.88;
            transform: translateY(-1px);
        }

        @media(max-width: 640px){
            .explain-comparison { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <strong style="color:var(--text)">ChromaAudit</strong><br>
        Color Intelligence · WCAG 2.1 · Fuzzy Logic Engine
    </div>
    <div class="badge">FUZZY ENGINE v2</div>
</header>

<!-- ═══════════════════════════════════════════════════════════
     EXTRACTOR DE PALETA — MOTOR PRINCIPAL
     URL Scanner + Imagen/Logo → Paleta automática → Fuzzy + WCAG
═══════════════════════════════════════════════════════════ -->
<div class="input-real-card" id="extractor-hero" style="margin-bottom:1.5rem;">

    <div class="input-real-header">
        <div>
            <h2>Extractor de Paleta del Mundo Real</h2>
            <p>// pega una URL o sube un logo · los colores alimentan el análisis difuso y el auditor WCAG</p>
        </div>
        <span class="lvl-badge lvl-aaa" style="align-self:flex-start">MOTOR PRINCIPAL</span>
    </div>

    <!-- TABS -->
    <div class="ir-tabs">
        <button class="ir-tab active" data-tab="url">🌐 URL / Sitio Web</button>
        <button class="ir-tab"        data-tab="img">🖼 Imagen / Logo</button>
    </div>

    <!-- ── TAB: URL SCANNER ── -->
    <div class="ir-panel active" id="tab-url">

        <div class="cors-note">
            ℹ️ El scanner extrae colores del CSS y HTML de cualquier URL pública.<br>
            Usa 5 proxies CORS en cascada — si uno falla, el siguiente toma el relevo automáticamente.<br>
            <strong style="color:var(--text)">Alternativa directa:</strong> abre el sitio → <strong style="color:var(--text)">Ctrl+U</strong> → copia el CSS/HTML fuente y pégalo en el campo.
        </div>

        <div class="url-form">
            <input class="url-input" id="url-input"
                   type="text"
                   placeholder="https://ejemplo.com  —ó—  pega tu CSS/HTML aquí"
                   spellcheck="false">
            <button class="btn-scan" id="btn-scan-url">ESCANEAR</button>
        </div>

        <div class="scan-status" id="scan-status"></div>

        <!-- Paleta extraída de URL -->
        <div id="url-colors-section" style="display:none">
            <h4 style="font-family:'Space Mono',monospace;font-size:0.62rem;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:0.75rem;">
                // colores encontrados — selecciona los que quieres auditar
            </h4>
            <div class="extracted-swatches" id="url-swatches"></div>
            <br>
            <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                <button class="btn-inject" id="btn-inject-url" disabled>
                    ↑ ENVIAR SELECCIÓN AL AUDITOR WCAG
                </button>
                <button class="btn-inject" id="btn-report-url" disabled 
                        style="background:transparent;color:var(--accent2);border:1px solid rgba(75,255,236,0.4);">
                    📊 ANÁLISIS DE PALETA
                </button>
            </div>
        </div>

    </div>

    <!-- ── TAB: IMAGEN / LOGO ── -->
    <div class="ir-panel" id="tab-img">

        <div class="drop-zone" id="drop-zone">
            <input type="file" id="img-file-input" accept="image/*">
            <span class="drop-icon">🖼</span>
            <div class="drop-label">
                <strong>Arrastra tu imagen aquí</strong><br>
                o haz clic para seleccionar — PNG, JPG, SVG, WebP, GIF
            </div>
        </div>

        <div class="color-count-row">
            <label>Colores a extraer:</label>
            <input type="range" id="color-count" min="2" max="8" value="6">
            <span class="color-count-val" id="color-count-val">6</span>
        </div>

        <div class="image-analysis-row" id="image-analysis-row" style="display:none">
            <div class="image-preview-wrap">
                <canvas id="image-preview-canvas"></canvas>
            </div>
            <div class="extracted-colors-wrap">
                <h4>// colores dominantes — k-means</h4>
                <div class="extracted-swatches" id="img-swatches"></div>
                <div style="display:flex;gap:0.75rem;flex-wrap:wrap;margin-top:0.5rem;">
                    <button class="btn-inject" id="btn-inject-img" disabled>
                        ↑ ENVIAR AL AUDITOR WCAG
                    </button>
                    <button class="btn-inject" id="btn-report-img" disabled
                            style="background:transparent;color:var(--accent2);border:1px solid rgba(75,255,236,0.4);">
                        📊 ANÁLISIS DE IMAGEN
                    </button>
                </div>
            </div>
        </div>

    </div>

</div>

<!-- CARD PRINCIPAL -->
<div class="card">
    <div class="row-top">

        <!-- SELECTOR DE COLOR -->
        <div class="picker-wrap">
            <h2>// selector de color — o selecciona de la paleta extraída ↓</h2>
            <input type="color" id="color-input" value="#CC66FF">
            <div class="hex-display" id="hex-display">#CC66FF</div>
            <div class="rgb-display" id="rgb-display">R: 204 · G: 102 · B: 255</div>
            <div class="method-badge">
                <span class="mbadge">RNA nativa JS</span>
                <span class="mbadge on">fuzzy logic ✓</span>
            </div>
            <!-- PALETA EXTRAÍDA — se llena al escanear -->
            <div id="fuzzy-palette-wrap" style="display:none;margin-top:1rem;">
                <div style="font-family:'Space Mono',monospace;font-size:0.6rem;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:0.5rem;">
                    // paleta extraída — click para analizar
                </div>
                <div id="fuzzy-palette-swatches" style="display:flex;flex-wrap:wrap;gap:0.4rem;"></div>
            </div>
        </div>

        <!-- PREVIEW -->
        <div class="preview-wrap">
            <h2>// preview texto adaptativo</h2>
            <div id="sitio">
                Sample Text Preview<br>
                <small>ChromaAudit · Adaptive contrast engine</small>
            </div>
        </div>
    </div>

    <!-- ESCALA LUMINOSIDAD -->
    <div class="scale-section">
        <h2>// escala de luminosidad perceptual (negro → gris → blanco)</h2>
        <div class="fuzzy-scale">
            <div id="scale-marker"></div>
        </div>
        <div class="scale-labels">
            <span>NEGRO (0)</span>
            <span>GRIS OSCURO</span>
            <span>GRIS MEDIO</span>
            <span>GRIS CLARO</span>
            <span>BLANCO (1)</span>
        </div>
    </div>

    <!-- CONJUNTOS DIFUSOS -->
    <div class="sets-row">
        <!-- Luminosidad -->
        <div class="set-card">
            <h3>// luminosidad (luma)</h3>
            <div id="set-luma-dark-name" class="set-name">OSCURO</div>
            <div class="bar-track"><div id="bar-dark" class="bar-fill" style="width:0%;background:#ff4b4b"></div></div>
            <div class="membership-val" id="val-dark">μ = 0.00</div>
            <br>
            <div id="set-luma-mid-name" class="set-name">GRIS MEDIO</div>
            <div class="bar-track"><div id="bar-mid" class="bar-fill" style="width:0%;background:#ffcc00"></div></div>
            <div class="membership-val" id="val-mid">μ = 0.00</div>
            <br>
            <div id="set-luma-light-name" class="set-name">CLARO</div>
            <div class="bar-track"><div id="bar-light" class="bar-fill" style="width:0%;background:#b0ff4b"></div></div>
            <div class="membership-val" id="val-light">μ = 0.00</div>
        </div>

        <!-- Saturación -->
        <div class="set-card">
            <h3>// saturación</h3>
            <div class="set-name">NEUTRO / GRIS</div>
            <div class="bar-track"><div id="bar-neutral" class="bar-fill" style="width:0%;background:#4bffec"></div></div>
            <div class="membership-val" id="val-neutral">μ = 0.00</div>
            <br>
            <div class="set-name">SATURADO</div>
            <div class="bar-track"><div id="bar-saturated" class="bar-fill" style="width:0%;background:#ff6b4b"></div></div>
            <div class="membership-val" id="val-saturated">μ = 0.00</div>
        </div>

        <!-- Tono -->
        <div class="set-card">
            <h3>// tono dominante</h3>
            <div class="set-name">FRÍO 🔵</div>
            <div class="bar-track"><div id="bar-cool" class="bar-fill" style="width:0%;background:#4b8fff"></div></div>
            <div class="membership-val" id="val-cool">μ = 0.00</div>
            <br>
            <div class="set-name">CÁLIDO 🔴</div>
            <div class="bar-track"><div id="bar-warm" class="bar-fill" style="width:0%;background:#ff8c4b"></div></div>
            <div class="membership-val" id="val-warm">μ = 0.00</div>
            <br>
            <div class="set-name">NEUTRO ⚪</div>
            <div class="bar-track"><div id="bar-tone-neutral" class="bar-fill" style="width:0%;background:#aaaaaa"></div></div>
            <div class="membership-val" id="val-tone-neutral">μ = 0.00</div>
        </div>
    </div>

    <!-- VISUALIZACIÓN DE FUNCIONES DE MEMBRESÍA -->
    <div class="inference-section" style="margin-top:1.5rem;">
        <h2>// funciones de membresía — luminosidad perceptual</h2>
        <canvas id="membership-canvas"></canvas>
    </div>

    <!-- REGLAS DE INFERENCIA -->
    <div class="inference-section">
        <h2>// base de reglas difusas activas</h2>
        <div class="rules-grid" id="rules-grid"></div>
    </div>

    <!-- OUTPUT -->
    <div class="output-section">
        <div class="output-verdict">
            <h3>// decisión difusa</h3>
            <div id="verdict-text">—</div>
            <div id="verdict-sub">aguardando entrada</div>
        </div>
        <div class="output-crisp">
            <h3>// valor defuzzificado (centroide)</h3>
            <div class="crisp-val" id="crisp-val">0.00</div>
            <div class="crisp-label">0 = negro · 1 = blanco · escala continua</div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════
         PUNTO 5 — EXPLICACIÓN DIFUSA COMO VENTAJA VISIBLE
    ═══════════════════════════════════════════════════════════ -->
    <div class="explanation-section">
        <div class="explanation-header">
            <h3>// ¿por qué este resultado? — explicación para clientes</h3>
            <button class="btn-toggle-explain" id="btn-toggle-explain">
                👁 MOSTRAR ANÁLISIS
            </button>
        </div>

        <div class="explanation-box" id="explanation-box">
            
            <!-- Intro contextual -->
            <div class="explain-intro">
                <strong>La lógica difusa explica sus decisiones.</strong> A diferencia de una regla binaria simple, 
                el sistema analiza múltiples factores simultáneamente: luminosidad perceptual, saturación, 
                temperatura de color (frío/cálido), y sus interacciones. Aquí está el razonamiento detrás 
                de la decisión actual:
            </div>

            <!-- Decisión principal -->
            <div class="explain-decision">
                <div class="explain-decision-title">
                    <span>💡</span>
                    <span id="explain-main-title">Decisión Principal</span>
                </div>
                <div class="explain-decision-body" id="explain-main-body">
                    Cargando análisis...
                </div>
            </div>

            <!-- Por qué difusa vs simple -->
            <div class="explain-why">
                <div class="explain-why-title">🔬 ventaja de la lógica difusa</div>
                <div class="explain-why-text" id="explain-advantage">
                    Una regla simple solo miraría si el color es "claro" u "oscuro" con un corte abrupto. 
                    La lógica difusa reconoce matices: este color puede ser 70% claro y 30% medio al mismo tiempo, 
                    permitiendo decisiones más suaves en las zonas grises.
                </div>
            </div>

            <!-- Comparación métodos -->
            <div class="explain-comparison">
                <div class="explain-method">
                    <h4>Red Neuronal</h4>
                    <div class="explain-method-value" id="nn-value">0.00</div>
                    <div class="explain-method-desc" id="nn-desc">
                        Aprendió patrones de 20 ejemplos entrenados. Predice basándose en similitud 
                        a colores vistos antes.
                    </div>
                </div>
                <div class="explain-method">
                    <h4>Lógica Difusa</h4>
                    <div class="explain-method-value" id="fuzzy-value">0.00</div>
                    <div class="explain-method-desc" id="fuzzy-desc">
                        Evalúa reglas explícitas sobre luminosidad, saturación y tono. 
                        Cada regla aporta con un peso proporcional.
                    </div>
                </div>
            </div>

            <!-- Caso especial si aplica -->
            <div id="special-case-container"></div>

            <!-- Modo presentación -->
            <div class="presentation-mode">
                <button class="btn-generate-report" id="btn-generate-report">
                    <span>📄</span>
                    <span>GENERAR REPORTE PARA CLIENTE</span>
                </button>
            </div>

        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════
     PUNTO 1 — AUDITORÍA WCAG AA / AAA — PALETA DE MARCA
═══════════════════════════════════════════════════════════ -->
<div class="wcag-card">

    <div class="wcag-header">
        <div class="wcag-header-left">
            <h2>Auditoría de Contraste WCAG</h2>
            <p>// análisis de accesibilidad · usa "Enviar al Auditor" desde el extractor para cargar tu paleta</p>
        </div>
        <div class="level-legend">
            <span class="lvl-badge lvl-fail">✕ FALLA &lt;3:1</span>
            <span class="lvl-badge lvl-aa">◎ AA ≥4.5</span>
            <span class="lvl-badge lvl-aaa">◉ AAA ≥7</span>
        </div>
    </div>

    <!-- STATS RESUMEN -->
    <div class="wcag-stats">
        <div class="stat-box">
            <div class="stat-number" id="stat-total" style="color:var(--text)">—</div>
            <div class="stat-label">combinaciones</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="stat-fail" style="color:#ff4b4b">—</div>
            <div class="stat-label">fallan</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="stat-aa" style="color:#ffcc00">—</div>
            <div class="stat-label">pasan AA</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="stat-aaa" style="color:#b0ff4b">—</div>
            <div class="stat-label">pasan AAA</div>
        </div>
    </div>

    <!-- PALETA DE ENTRADA -->
    <div class="palette-input-section">
        <h3>// paleta de marca — agrega tus colores (máx. 8)</h3>
        <div style="font-family:'Space Mono',monospace;font-size:0.58rem;color:var(--muted);margin-bottom:0.75rem;line-height:1.6;">
            💡 <strong style="color:var(--text)">Tres formas de agregar colores:</strong><br>
            • Click en el cuadrado → selector visual<br>
            • Escribe hex directamente en el campo de texto (#FF5733)<br>
            • Usa el botón + para agregar más
        </div>
        <div class="palette-slots" id="palette-slots"></div>
    </div>

    <!-- MATRIZ DE CONTRASTE -->
    <div class="contrast-matrix-wrap">
        <h3>// matriz de contraste — fondo (filas) × texto (columnas)</h3>
        <div id="matrix-container"></div>
    </div>

    <!-- REPORTE DETALLADO -->
    <div class="wcag-report">
        <h3>// reporte detallado — todas las combinaciones ordenadas por ratio</h3>
        <div class="report-list" id="report-list"></div>
    </div>

</div>

<!-- ═══════════════════════════════════════════════════════════
     PUNTO 3 — OUTPUT ACCIONABLE
     CSS · Tailwind · Figma · JSON → copiar/descargar
═══════════════════════════════════════════════════════════ -->
<div class="output-card">

    <div class="output-header">
        <div>
            <h2>Exportar Tokens de Diseño</h2>
            <p>// genera código listo para producción · solo combinaciones WCAG AA+ · copiar o descargar</p>
        </div>
        <span class="lvl-badge lvl-aaa" style="align-self:flex-start">PUNTO 3</span>
    </div>

    <!-- TABS DE FORMATO -->
    <div class="export-tabs">
        <button class="export-tab active" data-export="css">CSS Variables</button>
        <button class="export-tab"        data-export="tailwind">Tailwind Config</button>
        <button class="export-tab"        data-export="figma">Figma Tokens</button>
        <button class="export-tab"        data-export="json">JSON Raw</button>
    </div>

    <!-- ── TAB: CSS VARIABLES ── -->
    <div class="export-panel active" id="export-css">
        <div class="format-desc">
            📋 <strong>CSS Custom Properties</strong> — pega en tu archivo CSS principal.<br>
            Incluye variables de color + clases utilitarias para cada combinación accesible.
        </div>
        <div class="code-block" id="code-css"></div>
        <div class="code-actions">
            <button class="btn-copy" data-target="code-css">
                <span>📋</span> COPIAR CSS
            </button>
            <button class="btn-download" data-format="css">
                <span>⬇</span> DESCARGAR .CSS
            </button>
        </div>
    </div>

    <!-- ── TAB: TAILWIND CONFIG ── -->
    <div class="export-panel" id="export-tailwind">
        <div class="format-desc">
            🎨 <strong>Tailwind CSS Config</strong> — añade a tu <code>tailwind.config.js</code>.<br>
            Extiende la paleta por defecto con tus combinaciones accesibles.
        </div>
        <div class="code-block" id="code-tailwind"></div>
        <div class="code-actions">
            <button class="btn-copy" data-target="code-tailwind">
                <span>📋</span> COPIAR CONFIG
            </button>
            <button class="btn-download" data-format="tailwind">
                <span>⬇</span> DESCARGAR .JS
            </button>
        </div>
    </div>

    <!-- ── TAB: FIGMA TOKENS ── -->
    <div class="export-panel" id="export-figma">
        <div class="format-desc">
            🎨 <strong>Figma Design Tokens</strong> — formato JSON compatible con plugins como Tokens Studio.<br>
            Importa directo a tu sistema de diseño en Figma.
        </div>
        <div class="code-block" id="code-figma"></div>
        <div class="code-actions">
            <button class="btn-copy" data-target="code-figma">
                <span>📋</span> COPIAR JSON
            </button>
            <button class="btn-download" data-format="figma">
                <span>⬇</span> DESCARGAR .JSON
            </button>
        </div>
    </div>

    <!-- ── TAB: JSON RAW ── -->
    <div class="export-panel" id="export-json">
        <div class="format-desc">
            🔧 <strong>JSON Raw</strong> — estructura de datos pura para integración custom.<br>
            Incluye todos los metadatos: ratio WCAG, nivel AA/AAA, RGB, luminancia.
        </div>
        <div class="code-block" id="code-json"></div>
        <div class="code-actions">
            <button class="btn-copy" data-target="code-json">
                <span>📋</span> COPIAR JSON
            </button>
            <button class="btn-download" data-format="json">
                <span>⬇</span> DESCARGAR .JSON
            </button>
        </div>
    </div>

</div>

<!-- ═══════════════════════════════════════════════════════════
     PUNTO 4 — MEMORIA Y COMPARACIÓN
     Historial de paletas + comparador lado a lado
═══════════════════════════════════════════════════════════ -->
<div class="history-card">

    <div class="history-header">
        <div>
            <h2>Historial y Comparación de Paletas</h2>
            <p>// guarda versiones · compara lado a lado · restaura cualquier momento</p>
        </div>
        <span class="lvl-badge lvl-aaa" style="align-self:flex-start">PUNTO 4</span>
    </div>

    <!-- GUARDAR PALETA ACTUAL -->
    <div class="save-controls">
        <input class="palette-name-input" id="palette-name-input" 
               type="text" 
               placeholder="Nombre de esta versión (ej: 'V1 - Azul oscuro inicial')"
               maxlength="60">
        <button class="btn-save" id="btn-save-palette">
            💾 GUARDAR PALETA ACTUAL
        </button>
    </div>

    <!-- LISTA DE HISTORIAL -->
    <div id="history-list-container">
        <div class="history-empty">
            <span style="font-size:2rem;display:block;margin-bottom:0.5rem;opacity:0.4">📦</span>
            Aún no hay paletas guardadas.<br>
            Configura colores arriba y presiona "Guardar paleta actual".
        </div>
    </div>

    <!-- COMPARADOR -->
    <div class="compare-section" id="compare-section" style="display:none">
        <div class="compare-header">
            <h3>// comparador de versiones</h3>
            <button class="btn-compare" id="btn-run-compare" disabled>
                ⚖ COMPARAR SELECCIONADAS
            </button>
        </div>
        <div id="compare-result"></div>
    </div>

</div>

<footer>
    ChromaAudit · Color Intelligence Platform · WCAG 2.1 · Fuzzy Logic Engine
</footer>

<script>
// ================================================================
// CHROMAAUDIT — FUZZY COLOR INTELLIGENCE ENGINE
// Fuzzy Logic + Native Neural Network · Zero dependencies
// WCAG 2.1 Compliance · Design Token Export · Real-world extraction
// ================================================================

// ── 1. RED NEURONAL IMPLEMENTADA EN JS PURO ──────────────────────
// Arquitectura: 3 entradas (r,g,b) → capa oculta 8 neuronas → 1 salida
// Activación: sigmoid. Entrenamiento: backpropagation + SGD.

class NeuralNetwork {
    constructor(config = {}) {
        this.lr          = config.learningRate  || 0.3;
        this.hiddenSize  = config.hiddenLayers  ? config.hiddenLayers[0] : 8;
        this.iterations  = config.iterations    || 20000;
        this.inputSize   = 3;   // r, g, b
        this.outputSize  = 1;   // c (color de texto)
        this._init();
    }

    _rand() { return (Math.random() - 0.5) * 2; }

    _init() {
        // Pesos capa 1: input → hidden  [hiddenSize × 3]
        this.W1 = Array.from({length: this.hiddenSize}, () =>
            [this._rand(), this._rand(), this._rand()]);
        this.b1 = Array.from({length: this.hiddenSize}, () => this._rand());
        // Pesos capa 2: hidden → output [1 × hiddenSize]
        this.W2 = Array.from({length: this.hiddenSize}, () => this._rand());
        this.b2 = this._rand();
    }

    _sigmoid(x) { return 1 / (1 + Math.exp(-x)); }
    _sigDeriv(x) { const s = this._sigmoid(x); return s * (1 - s); }

    _forward(inp) {
        // inp = [r, g, b]
        // Capa oculta
        this.z1 = this.W1.map((row, i) =>
            row.reduce((sum, w, j) => sum + w * inp[j], 0) + this.b1[i]);
        this.a1 = this.z1.map(z => this._sigmoid(z));
        // Capa salida
        this.z2 = this.W2.reduce((sum, w, i) => sum + w * this.a1[i], 0) + this.b2;
        this.a2 = this._sigmoid(this.z2);
        return this.a2;
    }

    train(dataset) {
        // Convertir dataset a arrays internos
        const examples = dataset.map(d => ({
            inp: [d.input.r, d.input.g, d.input.b],
            out: d.output.c
        }));

        for (let iter = 0; iter < this.iterations; iter++) {
            // Mezclar dataset en cada época
            const shuffled = [...examples].sort(() => Math.random() - 0.5);
            shuffled.forEach(({ inp, out }) => {
                // Forward pass
                const pred = this._forward(inp);
                // Error en salida
                const dL_dA2 = pred - out;
                const dA2_dZ2 = this._sigDeriv(this.z2);
                const delta2 = dL_dA2 * dA2_dZ2;

                // Gradientes W2, b2
                const dW2 = this.a1.map(a => a * delta2);
                const db2 = delta2;

                // Backprop a capa oculta
                const delta1 = this.W2.map((w, i) =>
                    w * delta2 * this._sigDeriv(this.z1[i]));

                // Gradientes W1, b1
                const dW1 = delta1.map(d => inp.map(x => x * d));
                const db1 = delta1;

                // Actualizar pesos
                this.W2 = this.W2.map((w, i) => w - this.lr * dW2[i]);
                this.b2 -= this.lr * db2;
                this.W1 = this.W1.map((row, i) =>
                    row.map((w, j) => w - this.lr * dW1[i][j]));
                this.b1 = this.b1.map((b, i) => b - this.lr * db1[i]);
            });
        }
    }

    run(input) {
        const pred = this._forward([input.r, input.g, input.b]);
        return { c: pred };
    }
}

// Instanciar y entrenar (sin dependencias externas)
const network = new NeuralNetwork({ hiddenLayers: [8], learningRate: 0.3, iterations: 20000 });
network.train([
    {input:{r:0,   g:0,    b:0   }, output:{c:1}},
    {input:{r:1,   g:1,    b:1   }, output:{c:0}},
    {input:{r:0,   g:1,    b:0   }, output:{c:0}},
    {input:{r:0,   g:.43,  b:1   }, output:{c:1}},
    {input:{r:1,   g:0,    b:0   }, output:{c:1}},
    {input:{r:1,   g:1,    b:0   }, output:{c:0}},
    {input:{r:0,   g:1,    b:1   }, output:{c:0}},
    {input:{r:1,   g:0,    b:1   }, output:{c:1}},
    {input:{r:1,   g:.5,   b:0   }, output:{c:1}},
    {input:{r:0,   g:0,    b:.5  }, output:{c:1}},
    {input:{r:.8,  g:.8,   b:.8  }, output:{c:0}},
    {input:{r:.2,  g:.2,   b:.2  }, output:{c:1}},
    {input:{r:.7,  g:1,    b:.3  }, output:{c:0}},
    {input:{r:.6,  g:.2,   b:.7  }, output:{c:1}},
    {input:{r:1,   g:.75,  b:.8  }, output:{c:0}},
    {input:{r:.13, g:.55,  b:.13 }, output:{c:1}},
    {input:{r:.5,  g:0,    b:0   }, output:{c:1}},
    {input:{r:.8,  g:.6,   b:1   }, output:{c:0}},
    {input:{r:.3,  g:.8,   b:.8  }, output:{c:0}},
    {input:{r:.6,  g:.3,   b:.1  }, output:{c:1}}
]);

// ── 2. LÓGICA DIFUSA ────────────────────────────────────────────

// 2a. RGB → HSL
function rgbToHsl(r, g, b) {
    r /= 255; g /= 255; b /= 255;
    const max = Math.max(r, g, b), min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;
    if (max === min) { h = s = 0; }
    else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch(max) {
            case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
            case g: h = ((b - r) / d + 2) / 6; break;
            case b: h = ((r - g) / d + 4) / 6; break;
        }
    }
    return { h: h * 360, s, l };
}

// 2b. Luminosidad perceptual (luma CCIR601)
function calcLuma(r, g, b) {
    return (0.299 * r + 0.587 * g + 0.114 * b) / 255;
}

// 2c. Funciones de membresía trapezoidales/triangulares
// Función trapezoidal: sube de a a b, plana de b a c, baja de c a d
function trap(x, a, b, c, d) {
    if (x <= a || x >= d) return 0;
    if (x >= b && x <= c) return 1;
    if (x < b) return (x - a) / (b - a);
    return (d - x) / (d - c);
}

// Función triangular
function tri(x, a, b, c) {
    if (x <= a || x >= c) return 0;
    if (x === b) return 1;
    if (x < b) return (x - a) / (b - a);
    return (c - x) / (c - b);
}

// ── CONJUNTOS SOBRE LUMINOSIDAD (luma 0-1) ──
// OSCURO:     trapezoide izq [0, 0, 0.2, 0.45]
// GRIS_MEDIO: triángulo      [0.2, 0.45, 0.7]
// CLARO:      trapezoide der [0.55, 0.75, 1, 1]
function muOscuro(l)    { return trap(l, 0, 0, 0.20, 0.45); }
function muGrisMedio(l) { return tri(l, 0.20, 0.45, 0.70); }
function muClaro(l)     { return trap(l, 0.55, 0.75, 1.0, 1.0); }

// ── CONJUNTOS SOBRE SATURACIÓN (s 0-1) ──
function muNeutro(s)    { return trap(s, 0, 0, 0.10, 0.30); }
function muSaturado(s)  { return trap(s, 0.20, 0.45, 1.0, 1.0); }

// ── CONJUNTOS SOBRE TONO (h 0-360) ──
// Frío: azules/verdes (150-270)
// Cálido: rojos/amarillos/naranjas (0-60 y 300-360)
function muFrio(h) {
    if (h >= 150 && h <= 270) return 1;
    if (h > 270 && h <= 330) return (330 - h) / 60;
    if (h >= 90 && h < 150) return (h - 90) / 60;
    return 0;
}
function muCalido(h) {
    if (h <= 60) return 1;
    if (h > 60 && h <= 120) return (120 - h) / 60;
    if (h >= 300) return (h - 300) / 60;
    return 0;
}
function muTonoNeutro(h) { return 1 - Math.max(muFrio(h), muCalido(h)); }

// ── 2d. DEFUZZIFICACIÓN POR CENTROIDE ──
// Salida lingüística: "color de texto"
// 0 = negro, 1 = blanco
// Reglas → asignan valor de salida en [0,1] con peso μ
function defuzzify(rules) {
    // rules: array de {mu, crisp}
    // Método: centroide discreto = Σ(μi * ci) / Σ(μi)
    let num = 0, den = 0;
    for (const r of rules) {
        num += r.mu * r.crisp;
        den += r.mu;
    }
    return den < 0.001 ? 0.5 : num / den;
}

// ── 2e. MOTOR DE INFERENCIA MAMDANI ──
function fuzzyInference(rVal, gVal, bVal) {
    const luma = calcLuma(rVal, gVal, bVal);
    const hsl  = rgbToHsl(rVal, gVal, bVal);
    const s    = hsl.s;
    const h    = hsl.h;

    // Grados de membresía
    const mDark   = muOscuro(luma);
    const mMid    = muGrisMedio(luma);
    const mLight  = muClaro(luma);
    const mNeut   = muNeutro(s);
    const mSat    = muSaturado(s);
    const mCool   = muFrio(h);
    const mWarm   = muCalido(h);
    const mTNeu   = muTonoNeutro(h);

    // BASE DE REGLAS DIFUSAS
    // SI fondo es OSCURO → texto BLANCO (1.0)
    // SI fondo es GRIS_MEDIO → texto depende de saturación y tono
    // SI fondo es CLARO → texto NEGRO (0.0)
    // Reglas combinadas con operador AND (min)
    const rules = [
        { id: 'R1', label: 'SI oscuro → texto BLANCO',              mu: mDark,                         crisp: 1.0 },
        { id: 'R2', label: 'SI oscuro ∧ frío → texto BLANCO+',     mu: Math.min(mDark, mCool),        crisp: 1.0 },
        { id: 'R3', label: 'SI oscuro ∧ cálido → texto BLANCO',    mu: Math.min(mDark, mWarm),        crisp: 0.9 },
        { id: 'R4', label: 'SI gris medio → texto GRIS (adapt.)',   mu: mMid,                         crisp: 0.5 },
        { id: 'R5', label: 'SI gris ∧ saturado ∧ frío → BLANCO',   mu: Math.min(mMid, mSat, mCool),  crisp: 0.8 },
        { id: 'R6', label: 'SI gris ∧ saturado ∧ cálido → NEGRO',  mu: Math.min(mMid, mSat, mWarm),  crisp: 0.3 },
        { id: 'R7', label: 'SI gris ∧ neutro-sat → GRIS MEDIO',    mu: Math.min(mMid, mNeut),        crisp: 0.5 },
        { id: 'R8', label: 'SI claro → texto NEGRO',                mu: mLight,                       crisp: 0.0 },
        { id: 'R9', label: 'SI claro ∧ saturado → texto NEGRO',    mu: Math.min(mLight, mSat),       crisp: 0.05 },
        { id: 'R10',label: 'SI claro ∧ frío → texto NEGRO+',       mu: Math.min(mLight, mCool),      crisp: 0.1 },
        { id: 'R11',label: 'SI claro ∧ cálido → texto NEGRO',      mu: Math.min(mLight, mWarm),      crisp: 0.05 },
        { id: 'R12',label: 'SI claro ∧ neutro-sat → NEGRO',        mu: Math.min(mLight, mNeut),      crisp: 0.0 },
    ];

    const crisp = defuzzify(rules);
    return {
        luma, hsl, s, h,
        mDark, mMid, mLight,
        mNeut, mSat,
        mCool, mWarm, mTNeu,
        rules, crisp
    };
}

// ── 3. CANVAS — FUNCIONES DE MEMBRESÍA ──────────────────────────
function drawMembershipCanvas(luma) {
    const canvas = document.getElementById('membership-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth * window.devicePixelRatio;
    canvas.height = canvas.offsetHeight * window.devicePixelRatio;
    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    const W = canvas.offsetWidth, H = canvas.offsetHeight;
    ctx.clearRect(0, 0, W, H);

    // Fondo
    ctx.fillStyle = 'rgba(255,255,255,0.02)';
    ctx.fillRect(0, 0, W, H);

    // Grid
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 10; i++) {
        const x = (i / 10) * W;
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
    }
    for (let i = 0; i <= 4; i++) {
        const y = (i / 4) * H;
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
    }

    // Gradiente de fondo (escala negro-blanco)
    const grad = ctx.createLinearGradient(0, 0, W, 0);
    grad.addColorStop(0, 'rgba(0,0,0,0.15)');
    grad.addColorStop(0.5, 'rgba(128,128,128,0.1)');
    grad.addColorStop(1, 'rgba(255,255,255,0.15)');
    ctx.fillStyle = grad;
    ctx.fillRect(0, H * 0.7, W, H * 0.3);

    // Trazar curvas de membresía
    const funcs = [
        { fn: muOscuro,    color: '#ff4b4b', label: 'OSCURO' },
        { fn: muGrisMedio, color: '#ffcc00', label: 'GRIS MEDIO' },
        { fn: muClaro,     color: '#b0ff4b', label: 'CLARO' },
    ];

    funcs.forEach(({ fn, color, label }) => {
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2.5;
        for (let px = 0; px <= W; px++) {
            const x = px / W;
            const y = fn(x);
            const canvasY = H * 0.05 + (1 - y) * H * 0.85;
            if (px === 0) ctx.moveTo(px, canvasY);
            else ctx.lineTo(px, canvasY);
        }
        ctx.stroke();
        // Label al final de cada curva
        ctx.fillStyle = color;
        ctx.font = `bold 9px Space Mono, monospace`;
        ctx.fillText(label, 6 + funcs.indexOf(funcs.find(f=>f.fn===fn)) * (W/3), 14);
    });

    // Marcador de posición actual (luma)
    const markerX = luma * W;
    ctx.strokeStyle = '#4bffec';
    ctx.lineWidth = 2;
    ctx.setLineDash([4, 3]);
    ctx.beginPath(); ctx.moveTo(markerX, 0); ctx.lineTo(markerX, H); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#4bffec';
    ctx.font = '9px Space Mono, monospace';
    const labelX = markerX > W * 0.8 ? markerX - 40 : markerX + 4;
    ctx.fillText(`luma=${luma.toFixed(2)}`, labelX, H - 6);
}

// ── 4. ACTUALIZACIÓN DE LA UI ────────────────────────────────────

// Generar reglas en el DOM (solo 1 vez)
function buildRulesDOM(rules) {
    const grid = document.getElementById('rules-grid');
    grid.innerHTML = '';
    rules.forEach(r => {
        const div = document.createElement('div');
        div.className = 'rule';
        div.id = 'rule-' + r.id;
        div.innerHTML = `<div class="rule-dot"></div><span>${r.id}: ${r.label}</span>`;
        grid.appendChild(div);
    });
}

let rulesBuilt = false;

function update() {
    const hex = document.getElementById('color-input').value;

    // Extraer RGB
    const bigint = parseInt(hex.slice(1), 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8)  & 255;
    const b = bigint & 255;

    // Actualizar displays de color
    document.getElementById('hex-display').textContent = hex.toUpperCase();
    document.getElementById('rgb-display').textContent = `R: ${r} · G: ${g} · B: ${b}`;

    // ── FUZZY ──
    const fz = fuzzyInference(r, g, b);

    // ── NEURAL ──
    const nnResult = network.run({ r: r/255, g: g/255, b: b/255 });
    const nnCrisp  = nnResult.c;

    // Combinar RNA + difusa (promedio ponderado 40% RNA, 60% difusa)
    const combined = 0.4 * nnCrisp + 0.6 * fz.crisp;

    // ── PREVIEW DIV ──
    const sitio = document.getElementById('sitio');
    sitio.style.background = hex;
    // Color de texto: continuo entre negro y blanco
    // Interpolamos: combined < 0.5 → negro, > 0.5 → blanco
    const textLuma = Math.round(combined * 255);
    sitio.style.color = combined > 0.5 ? `rgb(255,255,255)` : `rgb(0,0,0)`;

    // Sombra de texto sutil para mejorar legibilidad en tonos medios
    const shadowAlpha = 1 - 2 * Math.abs(combined - 0.5); // máximo en 0.5
    sitio.style.textShadow = `0 1px 4px rgba(${combined>0.5?'0,0,0':'255,255,255'},${(shadowAlpha * 0.4).toFixed(2)})`;

    // ── MARCADOR EN ESCALA ──
    document.getElementById('scale-marker').style.left = (fz.luma * 100).toFixed(1) + '%';

    // ── BARRAS DE MEMBRESÍA ──
    setBar('bar-dark',  fz.mDark,  '#ff4b4b'); setVal('val-dark',  fz.mDark);
    setBar('bar-mid',   fz.mMid,   '#ffcc00'); setVal('val-mid',   fz.mMid);
    setBar('bar-light', fz.mLight, '#b0ff4b'); setVal('val-light', fz.mLight);

    setBar('bar-neutral',   fz.mNeut, '#4bffec');   setVal('val-neutral',   fz.mNeut);
    setBar('bar-saturated', fz.mSat,  '#ff6b4b');   setVal('val-saturated', fz.mSat);

    setBar('bar-cool',         fz.mCool, '#4b8fff'); setVal('val-cool',         fz.mCool);
    setBar('bar-warm',         fz.mWarm, '#ff8c4b'); setVal('val-warm',         fz.mWarm);
    setBar('bar-tone-neutral', fz.mTNeu, '#aaaaaa'); setVal('val-tone-neutral', fz.mTNeu);

    // ── CANVAS ──
    drawMembershipCanvas(fz.luma);

    // ── REGLAS ──
    if (!rulesBuilt) { buildRulesDOM(fz.rules); rulesBuilt = true; }
    fz.rules.forEach(r => {
        const el = document.getElementById('rule-' + r.id);
        if (el) el.className = 'rule' + (r.mu > 0.05 ? ' active' : '');
    });

    // ── VERDICT ──
    let verdictLabel, verdictColor;
    if (combined < 0.25) { verdictLabel = '⬛ NEGRO — fondo muy oscuro';       verdictColor = '#ff4b4b'; }
    else if (combined < 0.42) { verdictLabel = '🌑 GRIS OSCURO — fondo oscuro';    verdictColor = '#ff8c4b'; }
    else if (combined < 0.58) { verdictLabel = '🌓 GRIS MEDIO — zona de transición'; verdictColor = '#ffcc00'; }
    else if (combined < 0.75) { verdictLabel = '🌕 GRIS CLARO — fondo claro';      verdictColor = '#b0ff4b'; }
    else                       { verdictLabel = '⬜ BLANCO — fondo muy claro';      verdictColor = '#4bffec'; }

    const verdictEl = document.getElementById('verdict-text');
    verdictEl.textContent = verdictLabel;
    verdictEl.style.color = verdictColor;

    document.getElementById('verdict-sub').textContent =
        `Luma perceptual: ${(fz.luma*100).toFixed(1)}%  ·  ` +
        `Defuzz. difuso: ${fz.crisp.toFixed(3)}  ·  ` +
        `RNA: ${nnCrisp.toFixed(3)}  ·  ` +
        `Combinado: ${combined.toFixed(3)}`;

    document.getElementById('crisp-val').textContent = combined.toFixed(3);
}

function setBar(id, val, color) {
    const el = document.getElementById(id);
    if (el) { el.style.width = (val * 100).toFixed(1) + '%'; el.style.background = color; }
}
function setVal(id, val) {
    const el = document.getElementById(id);
    if (el) el.textContent = `μ = ${val.toFixed(3)}`;
}

// ── 5. EVENTOS ──────────────────────────────────────────────────
document.getElementById('color-input').addEventListener('input', update);
window.addEventListener('resize', () => {
    const hex = document.getElementById('color-input').value;
    const bigint = parseInt(hex.slice(1), 16);
    drawMembershipCanvas(calcLuma((bigint>>16)&255, (bigint>>8)&255, bigint&255));
});

// Inicializar
window.addEventListener('load', () => { setTimeout(update, 100); });

// ================================================================
// PUNTO 1 — MOTOR DE AUDITORÍA WCAG AA / AAA
// Implementación 100% fiel a W3C WCAG 2.1
// https://www.w3.org/TR/WCAG21/#contrast-minimum
// ================================================================

// ── PALETA INICIAL DE MARCA (5 colores representativos) ──
let brandPalette = [
    '#1a1a2e',  // azul muy oscuro
    '#16213e',  // azul marino
    '#0f3460',  // azul profundo
    '#e94560',  // rojo coral
    '#ffffff',  // blanco
];
const MAX_COLORS = 8;

// ── 1. FÓRMULA WCAG OFICIAL ──────────────────────────────────────

// Linearizar canal de color (sRGB → lineal)
function linearize(c) {
    const s = c / 255;
    return s <= 0.04045 ? s / 12.92 : Math.pow((s + 0.055) / 1.055, 2.4);
}

// Luminancia relativa W3C (0=negro, 1=blanco)
function relativeLuminance(hex) {
    const n = parseInt(hex.slice(1), 16);
    const r = (n >> 16) & 255;
    const g = (n >> 8)  & 255;
    const b = n & 255;
    const R = linearize(r), G = linearize(g), B = linearize(b);
    return 0.2126 * R + 0.7152 * G + 0.0722 * B;
}

// Ratio de contraste WCAG (siempre ≥ 1)
function contrastRatio(hex1, hex2) {
    const L1 = relativeLuminance(hex1);
    const L2 = relativeLuminance(hex2);
    const lighter = Math.max(L1, L2);
    const darker  = Math.min(L1, L2);
    return (lighter + 0.05) / (darker + 0.05);
}

// Clasificación WCAG
function wcagLevel(ratio) {
    if (ratio >= 7.0)  return 'AAA';
    if (ratio >= 4.5)  return 'AA';
    if (ratio >= 3.0)  return 'AA_LARGE'; // AA solo para texto grande (≥18pt bold)
    return 'FAIL';
}

// Color de texto legible sobre un fondo dado (para previews internos)
function readableTextColor(bgHex) {
    return relativeLuminance(bgHex) > 0.179 ? '#000000' : '#ffffff';
}

// ── 2. RENDER DE SLOTS DE PALETA ──────────────────────────────────
function renderPaletteSlots() {
    const container = document.getElementById('palette-slots');
    container.innerHTML = '';

    brandPalette.forEach((color, i) => {
        const slot = document.createElement('div');
        slot.className = 'color-slot';
        slot.dataset.index = i;
        
        // Swatch clickeable
        const swatch = document.createElement('div');
        swatch.className = 'palette-swatch-clickable';
        swatch.style.cssText = `
            width: 52px; 
            height: 52px; 
            border-radius: 12px; 
            background: ${color}; 
            border: 2px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: transform 0.15s, border-color 0.2s;
            position: relative;
        `;
        swatch.title = 'Click para cambiar color';
        
        // Input hex editable
        const hexInput = document.createElement('input');
        hexInput.type = 'text';
        hexInput.value = color.toUpperCase();
        hexInput.className = 'palette-hex-input';
        hexInput.maxLength = 7;
        hexInput.style.cssText = `
            width: 70px;
            padding: 0.3rem 0.5rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            text-align: center;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            outline: none;
            transition: border-color 0.2s;
        `;
        hexInput.placeholder = '#RRGGBB';
        
        // Validar hex al escribir
        hexInput.addEventListener('input', (e) => {
            let val = e.target.value.toUpperCase();
            if (val && !val.startsWith('#')) val = '#' + val;
            e.target.value = val;
            
            if (/^#[0-9A-F]{6}$/i.test(val)) {
                brandPalette[i] = val;
                swatch.style.background = val;
                hexInput.style.borderColor = 'var(--accent)';
                clearTimeout(hexInput.debounceTimer);
                hexInput.debounceTimer = setTimeout(() => {
                    runWcagAudit();
                }, 500);
            } else {
                hexInput.style.borderColor = '#ff4b4b';
            }
        });
        
        hexInput.addEventListener('focus', () => {
            if (!/^#[0-9A-F]{6}$/i.test(hexInput.value)) {
                hexInput.style.borderColor = 'rgba(176,255,75,0.4)';
            }
        });
        hexInput.addEventListener('blur', () => {
            const val = hexInput.value.toUpperCase();
            if (!/^#[0-9A-F]{6}$/i.test(val)) {
                hexInput.value = color.toUpperCase();
                hexInput.style.borderColor = 'var(--border)';
            } else {
                hexInput.style.borderColor = 'var(--border)';
            }
        });

        // Click en swatch → abrir picker custom
        swatch.addEventListener('click', () => {
            openCustomColorPicker(i, color, swatch, hexInput);
        });

        // Botón eliminar
        const removeBtn = document.createElement('button');
        removeBtn.className = 'slot-remove';
        removeBtn.innerHTML = '✕';
        removeBtn.title = 'Eliminar color';
        removeBtn.style.cssText = `
            position: absolute;
            top: -6px; right: -6px;
            width: 18px; height: 18px;
            border-radius: 50%;
            background: #ff4b4b;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
            z-index: 10;
        `;
        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            brandPalette.splice(i, 1);
            renderPaletteSlots();
            runWcagAudit();
        });

        slot.addEventListener('mouseenter', () => {
            removeBtn.style.display = 'flex';
        });
        slot.addEventListener('mouseleave', () => {
            removeBtn.style.display = 'none';
        });

        const swatchWrapper = document.createElement('div');
        swatchWrapper.style.position = 'relative';
        swatchWrapper.appendChild(removeBtn);
        swatchWrapper.appendChild(swatch);

        slot.appendChild(swatchWrapper);
        slot.appendChild(hexInput);
        container.appendChild(slot);
    });

    // Botón agregar
    if (brandPalette.length < MAX_COLORS) {
        const addBtn = document.createElement('button');
        addBtn.className = 'btn-add-color';
        addBtn.innerHTML = '+';
        addBtn.title = 'Agregar color';
        addBtn.addEventListener('click', () => {
            brandPalette.push('#888888');
            renderPaletteSlots();
            runWcagAudit();
        });
        container.appendChild(addBtn);
    }
}

// ── COLOR PICKER CUSTOM QUE PERMANECE ABIERTO ────────────────────

let activePickerIndex = null;
let pickerIsOpen      = false;   // flag: bloquea reconstrucción de slots
let wcagPendingUpdate = false;   // flag: hay una actualización esperando

function openCustomColorPicker(index, initialColor, swatchEl, hexInputEl) {
    // Cerrar picker anterior si existe
    closeCustomColorPicker();
    
    activePickerIndex = index;
    pickerIsOpen      = true;
    wcagPendingUpdate = false;
    
    // Overlay
    const overlay = document.createElement('div');
    overlay.className = 'picker-overlay visible';
    overlay.id = 'picker-overlay';
    overlay.addEventListener('click', closeCustomColorPicker);
    document.body.appendChild(overlay);
    
    // Picker
    const picker = document.createElement('div');
    picker.className = 'custom-color-picker visible';
    picker.id = 'custom-picker';
    
    // Parse color inicial
    const n = parseInt(initialColor.slice(1), 16);
    let r = (n >> 16) & 255;
    let g = (n >> 8) & 255;
    let b = n & 255;
    
    // HTML del picker
    picker.innerHTML = `
        <div class="picker-header">
            <div class="picker-title">Selector de Color</div>
            <button class="picker-close" onclick="closeCustomColorPicker()">✕</button>
        </div>
        
        <div class="picker-preview" id="picker-preview" style="background:${initialColor}"></div>
        
        <div class="picker-sliders">
            <div class="picker-slider-row">
                <div class="picker-slider-label">R</div>
                <input type="range" class="picker-slider" id="picker-r" min="0" max="255" value="${r}" 
                       style="background: linear-gradient(to right, #000, #f00)">
                <div class="picker-slider-value" id="picker-r-val">${r}</div>
            </div>
            <div class="picker-slider-row">
                <div class="picker-slider-label">G</div>
                <input type="range" class="picker-slider" id="picker-g" min="0" max="255" value="${g}"
                       style="background: linear-gradient(to right, #000, #0f0)">
                <div class="picker-slider-value" id="picker-g-val">${g}</div>
            </div>
            <div class="picker-slider-row">
                <div class="picker-slider-label">B</div>
                <input type="range" class="picker-slider" id="picker-b" min="0" max="255" value="${b}"
                       style="background: linear-gradient(to right, #000, #00f)">
                <div class="picker-slider-value" id="picker-b-val">${b}</div>
            </div>
        </div>
        
        <div class="picker-hex-row">
            <div class="picker-hex-label">HEX:</div>
            <input type="text" class="picker-hex-input" id="picker-hex-input" value="${initialColor.toUpperCase()}" maxlength="7">
        </div>
        
        <div class="picker-presets">
            <div class="picker-presets-label">Presets comunes</div>
            <div class="picker-presets-grid">
                ${['#000000','#FFFFFF','#FF0000','#00FF00','#0000FF','#FFFF00',
                   '#FF00FF','#00FFFF','#FF5733','#C70039','#900C3F','#581845'].map(c => 
                    `<div class="picker-preset-swatch" style="background:${c}" data-color="${c}"></div>`
                ).join('')}
            </div>
        </div>
    `;
    
    // Insertar después del slot correspondiente
    const slot = document.querySelector(`.color-slot[data-index="${index}"]`);
    slot.style.position = 'relative';
    slot.appendChild(picker);
    
    // Event listeners
    const updateColor = () => {
        const rVal = parseInt(document.getElementById('picker-r').value);
        const gVal = parseInt(document.getElementById('picker-g').value);
        const bVal = parseInt(document.getElementById('picker-b').value);
        
        const hex = '#' + [rVal, gVal, bVal]
            .map(v => v.toString(16).padStart(2, '0'))
            .join('').toUpperCase();
        
        document.getElementById('picker-preview').style.background = hex;
        document.getElementById('picker-hex-input').value = hex;
        document.getElementById('picker-r-val').textContent = rVal;
        document.getElementById('picker-g-val').textContent = gVal;
        document.getElementById('picker-b-val').textContent = bVal;
        
        // Actualizar en tiempo real
        brandPalette[index] = hex;
        swatchEl.style.background = hex;
        hexInputEl.value = hex;
        
        // Debounce para auditoría — picker abierto, solo actualiza matriz/reporte
        clearTimeout(updateColor.timer);
        updateColor.timer = setTimeout(() => runWcagAudit(), 400);
    };
    
    document.getElementById('picker-r').addEventListener('input', updateColor);
    document.getElementById('picker-g').addEventListener('input', updateColor);
    document.getElementById('picker-b').addEventListener('input', updateColor);
    
    // Hex input en picker
    document.getElementById('picker-hex-input').addEventListener('input', (e) => {
        let val = e.target.value.toUpperCase();
        if (val && !val.startsWith('#')) val = '#' + val;
        e.target.value = val;
        
        if (/^#[0-9A-F]{6}$/i.test(val)) {
            const n = parseInt(val.slice(1), 16);
            const rVal = (n >> 16) & 255;
            const gVal = (n >> 8) & 255;
            const bVal = n & 255;
            
            document.getElementById('picker-r').value = rVal;
            document.getElementById('picker-g').value = gVal;
            document.getElementById('picker-b').value = bVal;
            
            updateColor();
        }
    });
    
    // Presets
    picker.querySelectorAll('.picker-preset-swatch').forEach(preset => {
        preset.addEventListener('click', () => {
            const color = preset.dataset.color;
            const n = parseInt(color.slice(1), 16);
            
            document.getElementById('picker-r').value = (n >> 16) & 255;
            document.getElementById('picker-g').value = (n >> 8) & 255;
            document.getElementById('picker-b').value = n & 255;
            
            updateColor();
        });
    });
}

function closeCustomColorPicker() {
    const picker = document.getElementById('custom-picker');
    const overlay = document.getElementById('picker-overlay');
    
    if (picker) picker.remove();
    if (overlay) overlay.remove();
    
    activePickerIndex = null;
    pickerIsOpen      = false;

    // Si hubo cambios mientras el picker estaba abierto, aplicarlos ahora
    if (wcagPendingUpdate) {
        wcagPendingUpdate = false;
        runWcagAudit();
    }
}

// ── 3. RENDER DE MATRIZ ───────────────────────────────────────────
function renderMatrix(palette) {
    const container = document.getElementById('matrix-container');
    if (palette.length < 2) {
        container.innerHTML = '<p style="font-family:Space Mono,monospace;font-size:0.65rem;color:var(--muted)">Agrega al menos 2 colores para ver la matriz.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'contrast-matrix';

    // Encabezado (columnas = colores de texto)
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headerRow.appendChild(document.createElement('th')); // esquina vacía

    palette.forEach(color => {
        const th = document.createElement('th');
        th.innerHTML = `
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
                <div style="width:24px;height:24px;border-radius:6px;background:${color};border:1px solid rgba(255,255,255,0.1);"></div>
                <span style="font-size:0.48rem;">${color}</span>
            </div>`;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Cuerpo (filas = colores de fondo)
    const tbody = document.createElement('tbody');
    palette.forEach(bgColor => {
        const tr = document.createElement('tr');

        // Encabezado de fila
        const rowTh = document.createElement('th');
        rowTh.innerHTML = `
            <div class="matrix-row-header">
                <div class="row-swatch" style="background:${bgColor};"></div>
                <div class="row-hex-label">${bgColor}</div>
            </div>`;
        tr.appendChild(rowTh);

        // Celdas
        palette.forEach(textColor => {
            const td = document.createElement('td');
            const ratio = contrastRatio(bgColor, textColor);
            const level = wcagLevel(ratio);
            const isSame = bgColor === textColor;

            const cell = document.createElement('div');
            cell.className = 'matrix-cell' + (isSame ? ' same-color' : '');
            cell.style.background = isSame ? 'transparent' : bgColor;
            cell.title = `Fondo: ${bgColor} · Texto: ${textColor} · Ratio: ${ratio.toFixed(2)}:1`;

            if (!isSame) {
                // Ratio
                const ratioEl = document.createElement('div');
                ratioEl.className = 'cell-ratio';
                ratioEl.style.color = textColor;
                ratioEl.textContent = ratio.toFixed(1) + ':1';

                // Niveles
                const levelsEl = document.createElement('div');
                levelsEl.className = 'cell-levels';

                if (level === 'AAA') {
                    levelsEl.innerHTML = '<span class="cell-pip pip-aaa">AAA</span>';
                } else if (level === 'AA') {
                    levelsEl.innerHTML = '<span class="cell-pip pip-aa">AA</span>';
                } else if (level === 'AA_LARGE') {
                    levelsEl.innerHTML = '<span class="cell-pip pip-aa">AA★</span>';
                } else {
                    levelsEl.innerHTML = '<span class="cell-pip pip-fail">FAIL</span>';
                }

                cell.appendChild(ratioEl);
                cell.appendChild(levelsEl);
            } else {
                cell.innerHTML = '<span style="font-size:1.2rem;opacity:0.2">◼</span>';
            }

            td.appendChild(cell);
            tr.appendChild(td);
        });

        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.innerHTML = '';
    container.appendChild(table);
}

// ── 4. RENDER DE REPORTE DETALLADO ────────────────────────────────
function renderReport(palette) {
    const list = document.getElementById('report-list');
    list.innerHTML = '';

    if (palette.length < 2) return;

    // Generar todas las combinaciones únicas (sin repetir y sin mismo color)
    const combos = [];
    for (let i = 0; i < palette.length; i++) {
        for (let j = 0; j < palette.length; j++) {
            if (i === j) continue;
            const ratio = contrastRatio(palette[i], palette[j]);
            combos.push({ bg: palette[i], text: palette[j], ratio, level: wcagLevel(ratio) });
        }
    }

    // Ordenar: primero los que fallan, luego por ratio ascendente dentro del fallo, luego AA, luego AAA
    const order = { 'FAIL': 0, 'AA_LARGE': 1, 'AA': 2, 'AAA': 3 };
    combos.sort((a, b) => {
        if (order[a.level] !== order[b.level]) return order[a.level] - order[b.level];
        return a.ratio - b.ratio;
    });

    // Actualizar stats
    const total = combos.length;
    const fails = combos.filter(c => c.level === 'FAIL').length;
    const aaCount  = combos.filter(c => c.level === 'AA' || c.level === 'AAA').length;
    const aaaCount = combos.filter(c => c.level === 'AAA').length;

    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-fail').textContent  = fails;
    document.getElementById('stat-aa').textContent    = aaCount;
    document.getElementById('stat-aaa').textContent   = aaaCount;

    // Render de cada combo
    combos.forEach(({ bg, text, ratio, level }) => {
        const row = document.createElement('div');
        row.className = 'report-row';

        // Swatches
        const swatchPair = document.createElement('div');
        swatchPair.className = 'report-swatch-pair';
        swatchPair.innerHTML = `
            <div class="report-swatch" style="background:${bg};" title="Fondo"></div>
            <span style="font-family:Space Mono,monospace;font-size:0.6rem;color:var(--muted)">→</span>
            <div class="report-swatch" style="background:${text};" title="Texto"></div>`;

        // Preview de texto sobre fondo
        const preview = document.createElement('div');
        preview.className = 'report-preview';
        preview.style.background = bg;
        preview.style.color = text;
        preview.style.border = '1px solid rgba(255,255,255,0.08)';
        preview.textContent = 'Aa Texto';

        // Ratio
        const ratioEl = document.createElement('div');
        ratioEl.className = 'report-ratio';
        ratioEl.textContent = ratio.toFixed(2) + ':1';

        // Niveles
        const levelsEl = document.createElement('div');
        levelsEl.className = 'report-levels';
        let pipsHTML = '';
        if (level === 'AAA')      pipsHTML = '<span class="cell-pip pip-aaa">AAA</span><span class="cell-pip pip-aa">AA</span>';
        else if (level === 'AA')  pipsHTML = '<span class="cell-pip pip-aa">AA</span><span class="cell-pip pip-fail">AAA✕</span>';
        else if (level === 'AA_LARGE') pipsHTML = '<span class="cell-pip pip-aa">AA★</span><span class="cell-pip pip-fail">AA✕</span>';
        else                      pipsHTML = '<span class="cell-pip pip-fail">FAIL</span>';
        levelsEl.innerHTML = pipsHTML;

        // Veredicto textual
        const verdict = document.createElement('div');
        verdict.className = 'report-verdict';
        const bgLabel   = `${bg}`;
        const textLabel = `${text}`;
        if (level === 'AAA')       verdict.innerHTML = `<span style="color:#b0ff4b">✓ Óptimo</span>`;
        else if (level === 'AA')   verdict.innerHTML = `<span style="color:#ffcc00">✓ Accesible</span>`;
        else if (level === 'AA_LARGE') verdict.innerHTML = `<span style="color:#ff8c4b">⚠ Solo texto grande</span>`;
        else                       verdict.innerHTML = `<span style="color:#ff4b4b">✕ No accesible</span>`;

        row.appendChild(swatchPair);
        row.appendChild(preview);
        row.appendChild(ratioEl);
        row.appendChild(levelsEl);
        row.appendChild(verdict);
        list.appendChild(row);
    });
}

// ── 5. ORQUESTADOR PRINCIPAL WCAG ────────────────────────────────
function runWcagAudit() {
    // Si el picker está abierto: NO reconstruimos los slots (destruiría el picker)
    // Solo actualizamos matriz y reporte. Los slots se reconstruyen al cerrar.
    if (pickerIsOpen) {
        wcagPendingUpdate = true;   // marcar para ejecutar completo al cerrar
        renderMatrix(brandPalette);
        renderReport(brandPalette);
        return;
    }
    renderPaletteSlots();
    renderMatrix(brandPalette);
    renderReport(brandPalette);
}

// Inicializar WCAG al cargar
window.addEventListener('load', () => {
    setTimeout(() => { runWcagAudit(); }, 150);
});

// ================================================================
// PUNTO 2 — INPUT DEL MUNDO REAL
// A) URL Scanner: fetch + parser CSS/HTML → paleta
// B) Imagen/Logo: Canvas API + K-Means → colores dominantes
// ================================================================

// ── UTILIDADES DE COLOR ─────────────────────────────────────────

// Convierte cualquier string CSS de color a hex #rrggbb (o null si falla)
function cssColorToHex(str) {
    str = str.trim();
    if (!str || str === 'transparent' || str === 'inherit'
             || str === 'initial'     || str === 'currentcolor'
             || str === 'none')       return null;

    // Ya es hex
    if (/^#([0-9a-f]{3}){1,2}$/i.test(str)) {
        if (str.length === 4) {
            const r = str[1], g = str[2], b = str[3];
            return `#${r+r}${g+g}${b+b}`.toUpperCase();
        }
        return str.toUpperCase();
    }

    // rgb / rgba
    const rgb = str.match(/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);
    if (rgb) {
        return '#' + [rgb[1], rgb[2], rgb[3]]
            .map(v => parseInt(v).toString(16).padStart(2, '0'))
            .join('').toUpperCase();
    }

    // hsl / hsla → convertir
    const hsl = str.match(/hsla?\(\s*([\d.]+)\s*,\s*([\d.]+)%\s*,\s*([\d.]+)%/i);
    if (hsl) {
        const h = parseFloat(hsl[1]) / 360;
        const s = parseFloat(hsl[2]) / 100;
        const l = parseFloat(hsl[3]) / 100;
        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        const hue2rgb = (p, q, t) => {
            if (t < 0) t += 1; if (t > 1) t -= 1;
            if (t < 1/6) return p + (q - p) * 6 * t;
            if (t < 1/2) return q;
            if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
            return p;
        };
        const r = Math.round(hue2rgb(p, q, h + 1/3) * 255);
        const g = Math.round(hue2rgb(p, q, h)       * 255);
        const b = Math.round(hue2rgb(p, q, h - 1/3) * 255);
        return '#' + [r, g, b].map(v => v.toString(16).padStart(2, '0')).join('').toUpperCase();
    }

    // Nombres CSS comunes
    const named = {
        white:'#FFFFFF', black:'#000000', red:'#FF0000', green:'#008000',
        blue:'#0000FF', yellow:'#FFFF00', orange:'#FFA500', purple:'#800080',
        pink:'#FFC0CB', gray:'#808080', grey:'#808080', cyan:'#00FFFF',
        magenta:'#FF00FF', lime:'#00FF00', navy:'#000080', teal:'#008080',
        silver:'#C0C0C0', gold:'#FFD700', brown:'#A52A2A', coral:'#FF7F50',
        salmon:'#FA8072', violet:'#EE82EE', indigo:'#4B0082', beige:'#F5F5DC',
        ivory:'#FFFFF0', lavender:'#E6E6FA', maroon:'#800000',
    };
    const lower = str.toLowerCase().replace(/\s/g,'');
    return named[lower] || null;
}

// Parsear todos los colores de un bloque de texto CSS/HTML
function extractColorsFromText(text) {
    const found = new Set();

    // Hex
    const hexes = text.match(/#[0-9a-f]{6}\b|#[0-9a-f]{3}\b/gi) || [];
    hexes.forEach(h => {
        const hex = cssColorToHex(h);
        if (hex) found.add(hex);
    });

    // rgb/rgba/hsl/hsla
    const funcs = text.match(/(rgba?|hsla?)\([^)]+\)/gi) || [];
    funcs.forEach(f => {
        const hex = cssColorToHex(f);
        if (hex) found.add(hex);
    });

    // Nombres CSS en propiedades de color
    const props = text.match(/(?:color|background(?:-color)?|border(?:-color)?|fill|stroke)\s*:\s*([a-z]+)/gi) || [];
    props.forEach(p => {
        const val = p.split(':')[1]?.trim();
        const hex = val ? cssColorToHex(val) : null;
        if (hex) found.add(hex);
    });

    return [...found];
}

// Filtrar colores demasiado similares (distancia euclidiana en RGB < umbral)
function deduplicateColors(hexList, threshold = 30) {
    const result = [];
    const toRgb = h => {
        const n = parseInt(h.slice(1), 16);
        return [(n>>16)&255, (n>>8)&255, n&255];
    };
    for (const hex of hexList) {
        const rgb = toRgb(hex);
        const tooClose = result.some(existing => {
            const e = toRgb(existing);
            const d = Math.sqrt((rgb[0]-e[0])**2 + (rgb[1]-e[1])**2 + (rgb[2]-e[2])**2);
            return d < threshold;
        });
        if (!tooClose) result.push(hex);
    }
    return result;
}

// ── A) URL SCANNER ───────────────────────────────────────────────

let urlExtractedColors = [];
let urlSelectedColors  = new Set();

// ── PROXY CORS ───────────────────────────────────────────────────
// Estrategia:
//   1. Si el app corre en Vercel/servidor propio → usa /api/proxy (propio, sin límites)
//   2. Fallback: proxies públicos gratuitos (pueden fallar ocasionalmente)
//
// Para desplegar en Vercel: incluye el archivo api/proxy.js del proyecto.

async function fetchViaProxy(url, onProgress) {
    const encoded = encodeURIComponent(url);
    const errors  = [];

    async function tryFetch(label, fetchUrl, opts = {}) {
        try {
            onProgress && onProgress(label);
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), 12000);
            const res = await fetch(fetchUrl, { ...opts, signal: controller.signal });
            clearTimeout(timer);
            if (!res.ok) { errors.push(label + ': HTTP ' + res.status); return null; }
            const text = await res.text();
            // Rechazar respuestas JSON de error (proxy propio devuelve JSON en error)
            if (text && text.length > 100 && !text.trim().startsWith('{"error"')) return text;
            errors.push(label + ': respuesta vacía o error');
        } catch(e) {
            errors.push(label + ': ' + (e.message || 'timeout'));
        }
        return null;
    }

    async function tryFetchJSON(label, fetchUrl) {
        try {
            onProgress && onProgress(label);
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), 12000);
            const res = await fetch(fetchUrl, { signal: controller.signal });
            clearTimeout(timer);
            if (!res.ok) { errors.push(label + ': HTTP ' + res.status); return null; }
            const json = await res.json();
            const text = json && (json.contents || json.data || json.body) || '';
            if (text && text.length > 100) return text;
            errors.push(label + ': sin contenido');
        } catch(e) {
            errors.push(label + ': ' + (e.message || 'timeout'));
        }
        return null;
    }

    // ── PROXY 1: Serverless propio (Vercel /api/proxy) ──
    // Solo intenta si la app NO está abierta como archivo local (file://)
    const isDeployed = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
    if (isDeployed) {
        let r = await tryFetch('proxy propio (/api/proxy)', '/api/proxy?url=' + encoded);
        if (r) return r;
    }

    // ── PROXY 2: corsproxy.io ──
    let r = await tryFetch('corsproxy.io', 'https://corsproxy.io/?url=' + encoded);
    if (r) return r;

    // ── PROXY 3: allorigins raw ──
    r = await tryFetch('allorigins/raw', 'https://api.allorigins.win/raw?url=' + encoded);
    if (r) return r;

    // ── PROXY 4: allorigins JSON ──
    r = await tryFetchJSON('allorigins/get', 'https://api.allorigins.win/get?url=' + encoded);
    if (r) return r;

    // ── PROXY 5: cors.eu.org ──
    r = await tryFetch('cors.eu.org', 'https://cors.eu.org/' + url);
    if (r) return r;

    // ── PROXY 6: codetabs ──
    r = await tryFetch('codetabs', 'https://api.codetabs.com/v1/proxy?quest=' + encoded);
    if (r) return r;

    throw new Error(
        'Todos los proxies fallaron.\n' +
        'Detalle: ' + errors.join(' | ') + '\n\n' +
        '💡 Solución: abre el sitio en tu navegador → Ctrl+U (Ver fuente) → copia el HTML/CSS y pégalo en este campo.'
    );
}

function setStatus(msg, type) {
    const el = document.getElementById('scan-status');
    el.className = 'scan-status ' + type;
    el.innerHTML = type === 'loading'
        ? `<span class="spinner"></span>${msg}`
        : msg;
}

function renderUrlSwatches(colors) {
    const container = document.getElementById('url-swatches');
    container.innerHTML = '';
    urlSelectedColors.clear();

    colors.forEach(hex => {
        const wrap = document.createElement('div');
        wrap.className = 'ext-swatch selected'; // todos seleccionados por defecto
        urlSelectedColors.add(hex);

        const swatch = document.createElement('div');
        swatch.className = 'ext-swatch-color';
        swatch.style.background = hex;

        const label = document.createElement('div');
        label.className = 'ext-swatch-hex';
        label.textContent = hex;

        wrap.appendChild(swatch);
        wrap.appendChild(label);
        container.appendChild(wrap);

        wrap.addEventListener('click', () => {
            if (urlSelectedColors.has(hex)) {
                urlSelectedColors.delete(hex);
                wrap.classList.remove('selected');
            } else {
                urlSelectedColors.add(hex);
                wrap.classList.add('selected');
            }
            document.getElementById('btn-inject-url').disabled = urlSelectedColors.size === 0;
        });
    });

    document.getElementById('url-colors-section').style.display = 'block';
    document.getElementById('btn-inject-url').disabled = colors.length === 0;
    updateReportButtons();

    // ── Conectar al analizador difuso ──
    updateFuzzyPalette(colors);
}

// ── PALETA EXTRAÍDA → MOTOR DIFUSO ──────────────────────────────
// Muestra los colores extraídos como mini-paleta en el selector difuso
// y al hacer click en uno lo carga en #color-input para analizarlo
function updateFuzzyPalette(colors) {
    const wrap = document.getElementById('fuzzy-palette-wrap');
    const swatchesEl = document.getElementById('fuzzy-palette-swatches');
    if (!wrap || !swatchesEl || !colors.length) return;

    swatchesEl.innerHTML = '';
    colors.forEach((hex, i) => {
        const btn = document.createElement('button');
        btn.title = hex;
        btn.style.cssText = `
            width: 34px; height: 34px; border-radius: 8px;
            background: ${hex}; border: 2px solid rgba(255,255,255,0.1);
            cursor: pointer; transition: transform 0.15s, border-color 0.15s;
            padding: 0; position: relative;
        `;
        btn.addEventListener('mouseenter', () => {
            btn.style.transform = 'scale(1.15)';
            btn.style.borderColor = 'rgba(176,255,75,0.6)';
        });
        btn.addEventListener('mouseleave', () => {
            btn.style.transform = 'scale(1)';
            btn.style.borderColor = 'rgba(255,255,255,0.1)';
        });
        btn.addEventListener('click', () => {
            // Marcar activo
            swatchesEl.querySelectorAll('button').forEach(b => {
                b.style.borderColor = 'rgba(255,255,255,0.1)';
                b.style.boxShadow = 'none';
            });
            btn.style.borderColor = 'var(--accent)';
            btn.style.boxShadow = '0 0 0 3px rgba(176,255,75,0.3)';

            // Cargar en el selector de color y disparar análisis
            const colorInput = document.getElementById('color-input');
            colorInput.value = hex;
            colorInput.dispatchEvent(new Event('input'));

            // Scroll suave al fuzzy engine si está fuera de vista
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
        swatchesEl.appendChild(btn);

        // Activar el primer color automáticamente
        if (i === 0) {
            setTimeout(() => btn.click(), 100);
        }
    });

    wrap.style.display = 'block';
}

document.getElementById('btn-scan-url').addEventListener('click', async () => {
    const rawInput = document.getElementById('url-input').value.trim();
    if (!rawInput) return;

    const btn = document.getElementById('btn-scan-url');
    btn.disabled = true;
    document.getElementById('url-colors-section').style.display = 'none';

    // Detectar si es URL o texto directo (CSS/HTML pegado)
    const isURL = /^https?:\/\//i.test(rawInput);

    try {
        let text;
        if (isURL) {
            setStatus('Intentando proxy 1 de 5…', 'loading');
            text = await fetchViaProxy(rawInput, (label) => {
                setStatus('⟳ Probando ' + label + '…', 'loading');
            });
            setStatus('✓ Respuesta recibida — analizando colores…', 'loading');
        } else {
            // Es CSS/HTML pegado directamente
            text = rawInput;
            setStatus('Analizando texto…', 'loading');
        }

        // Extraer y limpiar colores
        let colors = extractColorsFromText(text);

        // Filtrar blanco puro y negro puro solos (suelen ser ruido)
        colors = colors.filter(c => c !== '#000000' && c !== '#FFFFFF');

        // Deduplicar colores similares
        colors = deduplicateColors(colors, 25);

        // Añadir blanco y negro al final (siempre útiles para contraste)
        if (!colors.includes('#FFFFFF')) colors.push('#FFFFFF');
        if (!colors.includes('#000000')) colors.push('#000000');

        // Limitar a 16 colores más relevantes (ya deduplicados)
        colors = colors.slice(0, 16);

        if (colors.length < 2) {
            setStatus('⚠ No se encontraron suficientes colores. Prueba pegando el CSS directamente.', 'error');
        } else {
            urlExtractedColors = colors;
            renderUrlSwatches(colors);
            setStatus(`✓ ${colors.length} colores únicos encontrados — selecciona cuáles auditar`, 'success');
        }

    } catch (err) {
        const msg = err.message.replace(/\n/g, '<br>');
        setStatus('✗ ' + msg, 'error');
    } finally {
        btn.disabled = false;
    }
});

document.getElementById('btn-inject-url').addEventListener('click', () => {
    const selected = [...urlSelectedColors];
    if (selected.length < 2) return;
    brandPalette = selected.slice(0, MAX_COLORS);
    runWcagAudit();
    // Scroll suave al auditor WCAG
    document.querySelector('.wcag-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
});

// ── B) IMAGEN / LOGO — K-MEANS ───────────────────────────────────

let imgExtractedColors  = [];
let imgSelectedColors   = new Set();

// K-Means en espacio RGB para encontrar colores dominantes
function kMeans(pixels, k, iterations = 15) {
    // pixels: array de [r, g, b]
    if (pixels.length === 0 || k <= 0) return [];

    // Inicializar centroides con k-means++ (mejor convergencia)
    const centroids = [pixels[Math.floor(Math.random() * pixels.length)]];
    while (centroids.length < k) {
        const dists = pixels.map(p => {
            const minD = Math.min(...centroids.map(c =>
                (p[0]-c[0])**2 + (p[1]-c[1])**2 + (p[2]-c[2])**2));
            return minD;
        });
        const total = dists.reduce((a, b) => a + b, 0);
        let r = Math.random() * total;
        for (let i = 0; i < dists.length; i++) {
            r -= dists[i];
            if (r <= 0) { centroids.push(pixels[i]); break; }
        }
    }

    let assignments = new Array(pixels.length).fill(0);

    for (let iter = 0; iter < iterations; iter++) {
        // Asignar cada píxel al centroide más cercano
        let changed = false;
        for (let i = 0; i < pixels.length; i++) {
            const p = pixels[i];
            let minD = Infinity, minIdx = 0;
            for (let j = 0; j < centroids.length; j++) {
                const c = centroids[j];
                const d = (p[0]-c[0])**2 + (p[1]-c[1])**2 + (p[2]-c[2])**2;
                if (d < minD) { minD = d; minIdx = j; }
            }
            if (assignments[i] !== minIdx) { assignments[i] = minIdx; changed = true; }
        }
        if (!changed) break;

        // Recalcular centroides
        for (let j = 0; j < k; j++) {
            const cluster = pixels.filter((_, i) => assignments[i] === j);
            if (cluster.length === 0) continue;
            centroids[j] = [
                Math.round(cluster.reduce((s, p) => s + p[0], 0) / cluster.length),
                Math.round(cluster.reduce((s, p) => s + p[1], 0) / cluster.length),
                Math.round(cluster.reduce((s, p) => s + p[2], 0) / cluster.length),
            ];
        }
    }

    // Calcular tamaño de cada cluster (para ordenar por predominancia)
    const clusterSizes = centroids.map((_, j) =>
        assignments.filter(a => a === j).length);

    // Ordenar por tamaño descendente
    return centroids
        .map((c, j) => ({ rgb: c, count: clusterSizes[j] }))
        .sort((a, b) => b.count - a.count)
        .map(({ rgb, count }) => ({
            hex: '#' + rgb.map(v => Math.min(255, Math.max(0, v))
                .toString(16).padStart(2, '0')).join('').toUpperCase(),
            pct: count
        }));
}

function renderImgSwatches(clusters, totalPixels) {
    const container = document.getElementById('img-swatches');
    container.innerHTML = '';
    imgSelectedColors.clear();

    clusters.forEach(({ hex, pct }) => {
        const wrap = document.createElement('div');
        wrap.className = 'ext-swatch selected';
        imgSelectedColors.add(hex);

        const swatch = document.createElement('div');
        swatch.className = 'ext-swatch-color';
        swatch.style.background = hex;

        const label = document.createElement('div');
        label.className = 'ext-swatch-hex';
        label.textContent = hex;

        const pctLabel = document.createElement('div');
        pctLabel.className = 'ext-swatch-pct';
        pctLabel.textContent = ((pct / totalPixels) * 100).toFixed(1) + '%';

        wrap.append(swatch, label, pctLabel);
        container.appendChild(wrap);

        wrap.addEventListener('click', () => {
            if (imgSelectedColors.has(hex)) {
                imgSelectedColors.delete(hex);
                wrap.classList.remove('selected');
            } else {
                imgSelectedColors.add(hex);
                wrap.classList.add('selected');
            }
            document.getElementById('btn-inject-img').disabled = imgSelectedColors.size === 0;
        });
    });

    document.getElementById('btn-inject-img').disabled = clusters.length === 0;
    updateReportButtons();

    // ── Conectar al analizador difuso ──
    updateFuzzyPalette(clusters.map(c => c.hex));
}

function processImage(file) {
    const k = parseInt(document.getElementById('color-count').value);
    const reader = new FileReader();
    reader.onload = e => {
        const img = new Image();
        img.onload = () => {
            // Preview
            const previewCanvas = document.getElementById('image-preview-canvas');
            const maxW = 340, maxH = 200;
            const scale = Math.min(maxW / img.width, maxH / img.height, 1);
            previewCanvas.width  = Math.round(img.width  * scale);
            previewCanvas.height = Math.round(img.height * scale);
            const pCtx = previewCanvas.getContext('2d');
            pCtx.drawImage(img, 0, 0, previewCanvas.width, previewCanvas.height);
            document.getElementById('image-analysis-row').style.display = 'grid';

            // Muestrear píxeles (reducir a 150×150 máx para velocidad)
            const sampleCanvas = document.createElement('canvas');
            const sW = Math.min(img.width,  150);
            const sH = Math.min(img.height, 150);
            sampleCanvas.width = sW; sampleCanvas.height = sH;
            sampleCanvas.getContext('2d').drawImage(img, 0, 0, sW, sH);
            const data = sampleCanvas.getContext('2d').getImageData(0, 0, sW, sH).data;

            // Convertir a array de [r,g,b], saltar píxeles transparentes
            const pixels = [];
            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] < 128) continue; // skip transparent
                pixels.push([data[i], data[i+1], data[i+2]]);
            }

            // K-Means
            const clusters = kMeans(pixels, k);
            imgExtractedColors = clusters.map(c => c.hex);

            renderImgSwatches(clusters, pixels.length);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// Eventos imagen
document.getElementById('img-file-input').addEventListener('change', e => {
    if (e.target.files[0]) processImage(e.target.files[0]);
});
document.getElementById('color-count').addEventListener('input', e => {
    document.getElementById('color-count-val').textContent = e.target.value;
    const file = document.getElementById('img-file-input').files[0];
    if (file) processImage(file);
});

// Drag & drop
const dropZone = document.getElementById('drop-zone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
        processImage(file);
    }
});

// Botón inyectar imagen → WCAG
document.getElementById('btn-inject-img').addEventListener('click', () => {
    const selected = [...imgSelectedColors];
    if (selected.length < 2) return;
    brandPalette = selected.slice(0, MAX_COLORS);
    runWcagAudit();
    document.querySelector('.wcag-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
});

// ── TABS ─────────────────────────────────────────────────────────
document.querySelectorAll('.ir-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.ir-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.ir-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
});

// ================================================================
// PUNTO 3 — OUTPUT ACCIONABLE
// Generadores de CSS, Tailwind, Figma, JSON desde auditoría WCAG
// ================================================================

// ── UTILIDADES ───────────────────────────────────────────────────

// Generar nombre semántico para un color (ej: #1a1a2e → "dark-blue")
function colorToName(hex) {
    const L = relativeLuminance(hex);
    const n = parseInt(hex.slice(1), 16);
    const r = (n >> 16) & 255, g = (n >> 8) & 255, b = n & 255;

    // Luminosidad
    let lum = '';
    if (L < 0.15)      lum = 'dark';
    else if (L < 0.4)  lum = 'medium';
    else if (L < 0.7)  lum = 'light';
    else               lum = 'pale';

    // Tono dominante
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    const delta = max - min;
    let hue = '';

    if (delta < 15) { // gris
        if (L < 0.2)      return 'black';
        if (L > 0.85)     return 'white';
        return lum === 'dark' ? 'gray-dark' : lum === 'medium' ? 'gray' : 'gray-light';
    }

    // Calcular hue
    let h = 0;
    if (max === r)      h = ((g - b) / delta + (g < b ? 6 : 0)) / 6;
    else if (max === g) h = ((b - r) / delta + 2) / 6;
    else                h = ((r - g) / delta + 4) / 6;
    h *= 360;

    if (h >= 345 || h < 15)        hue = 'red';
    else if (h >= 15  && h < 45)   hue = 'orange';
    else if (h >= 45  && h < 70)   hue = 'yellow';
    else if (h >= 70  && h < 150)  hue = 'green';
    else if (h >= 150 && h < 200)  hue = 'cyan';
    else if (h >= 200 && h < 260)  hue = 'blue';
    else if (h >= 260 && h < 300)  hue = 'purple';
    else                            hue = 'magenta';

    // Casos especiales
    if (hex === '#FFFFFF') return 'white';
    if (hex === '#000000') return 'black';

    return `${lum}-${hue}`;
}

// Deduplicar nombres (agregar sufijos si colisionan)
function makeUniqueNames(hexList) {
    const names = new Map();
    const counts = {};
    
    hexList.forEach(hex => {
        let base = colorToName(hex);
        if (!counts[base]) counts[base] = 0;
        counts[base]++;
        const name = counts[base] === 1 ? base : `${base}-${counts[base]}`;
        names.set(hex, name);
    });
    
    return names;
}

// ── GENERADORES DE FORMATO ───────────────────────────────────────

// Obtener todas las combinaciones WCAG AA+ actuales
function getAccessibleCombos() {
    const palette = brandPalette;
    if (palette.length < 2) return [];

    const combos = [];
    for (let i = 0; i < palette.length; i++) {
        for (let j = 0; j < palette.length; j++) {
            if (i === j) continue;
            const bg = palette[i], text = palette[j];
            const ratio = contrastRatio(bg, text);
            const level = wcagLevel(ratio);
            // Solo AA y AAA (descartamos FAIL y AA_LARGE)
            if (level === 'AA' || level === 'AAA') {
                combos.push({ bg, text, ratio, level });
            }
        }
    }
    
    // Ordenar por ratio descendente (mejores primero)
    combos.sort((a, b) => b.ratio - a.ratio);
    return combos;
}

// 1. CSS Variables + Utility Classes
function generateCSS(combos) {
    if (combos.length === 0) {
        return '/* No hay combinaciones WCAG AA+ para exportar.\n   Añade colores a la paleta del auditor arriba. */';
    }

    const allColors = [...new Set([...combos.map(c => c.bg), ...combos.map(c => c.text)])];
    const names = makeUniqueNames(allColors);

    let css = '/* ═══════════════════════════════════════════════════\n';
    css +=    '   SISTEMA DE COLORES ACCESIBLE\n';
    css +=    '   Generated with Fuzzy Logic + WCAG audit engine\n';
    css +=    `   ${combos.length} AA/AAA certified combinations\n`;
    css +=    '   ChromaAudit · Color Intelligence Platform\n';
    css +=    '   ═══════════════════════════════════════════════════ */\n\n';

    css += ':root {\n';
    css += '  /* ── Colores base ── */\n';
    allColors.forEach(hex => {
        css += `  --color-${names.get(hex)}: ${hex};\n`;
    });

    css += '\n  /* ── Combinaciones accesibles (bg + text) ── */\n';
    combos.forEach((c, i) => {
        const id = `combo-${i + 1}`;
        css += `  --${id}-bg: ${c.bg};\n`;
        css += `  --${id}-text: ${c.text};\n`;
        css += `  /* ratio: ${c.ratio.toFixed(2)}:1 · ${c.level} */\n`;
    });
    css += '}\n\n';

    // Clases utilitarias
    css += '/* ── Clases utilitarias ── */\n';
    combos.forEach((c, i) => {
        const id = `combo-${i + 1}`;
        css += `.${id} {\n`;
        css += `  background-color: var(--${id}-bg);\n`;
        css += `  color: var(--${id}-text);\n`;
        css += `}\n`;
    });

    return css;
}

// 2. Tailwind Config
function generateTailwind(combos) {
    if (combos.length === 0) {
        return '// No hay combinaciones WCAG AA+ para exportar.';
    }

    const allColors = [...new Set([...combos.map(c => c.bg), ...combos.map(c => c.text)])];
    const names = makeUniqueNames(allColors);

    let tw = '// ═══════════════════════════════════════════════════\n';
    tw +=    '// TAILWIND CONFIG — ACCESSIBLE COLOR SYSTEM\n';
    tw +=    `// ${combos.length} AA/AAA certified combinations\n`;
    tw +=    '// ChromaAudit · Color Intelligence Platform\n';
    tw +=    '// ═══════════════════════════════════════════════════\n\n';

    tw += 'module.exports = {\n';
    tw += '  theme: {\n';
    tw += '    extend: {\n';
    tw += '      colors: {\n';

    allColors.forEach(hex => {
        tw += `        '${names.get(hex)}': '${hex}',\n`;
    });

    tw += '      },\n';
    tw += '      // Combinaciones pre-certificadas WCAG\n';
    tw += '      backgroundColor: {\n';
    combos.forEach((c, i) => {
        tw += `        'safe-${i + 1}': '${c.bg}', // con text-safe-${i + 1}\n`;
    });
    tw += '      },\n';
    tw += '      textColor: {\n';
    combos.forEach((c, i) => {
        tw += `        'safe-${i + 1}': '${c.text}', // ratio ${c.ratio.toFixed(2)} ${c.level}\n`;
    });
    tw += '      },\n';
    tw += '    },\n';
    tw += '  },\n';
    tw += '};\n';

    return tw;
}

// 3. Figma Tokens (Tokens Studio format)
function generateFigma(combos) {
    if (combos.length === 0) {
        return '{\n  "error": "No hay combinaciones WCAG AA+ para exportar"\n}';
    }

    const allColors = [...new Set([...combos.map(c => c.bg), ...combos.map(c => c.text)])];
    const names = makeUniqueNames(allColors);

    const tokens = {
        color: {},
        accessible: {}
    };

    // Colores base
    allColors.forEach(hex => {
        tokens.color[names.get(hex)] = {
            value: hex,
            type: 'color'
        };
    });

    // Combinaciones accesibles
    combos.forEach((c, i) => {
        const id = `combo-${i + 1}`;
        tokens.accessible[id] = {
            background: { value: c.bg, type: 'color' },
            text: { value: c.text, type: 'color' },
            metadata: {
                wcag: c.level,
                ratio: parseFloat(c.ratio.toFixed(2))
            }
        };
    });

    return JSON.stringify(tokens, null, 2);
}

// 4. JSON Raw
function generateJSON(combos) {
    if (combos.length === 0) {
        return '{\n  "combinations": [],\n  "error": "No hay combinaciones WCAG AA+ para exportar"\n}';
    }

    const allColors = [...new Set([...combos.map(c => c.bg), ...combos.map(c => c.text)])];
    const names = makeUniqueNames(allColors);

    const data = {
        metadata: {
            generator: 'Deep Learning Color System',
            author: 'ChromaAudit',
            platform: 'Color Intelligence Engine',
            engine: 'Fuzzy Logic + Neural Network',
            standard: 'WCAG 2.1',
            generated: new Date().toISOString()
        },
        palette: allColors.map(hex => ({
            hex,
            name: names.get(hex),
            rgb: {
                r: parseInt(hex.slice(1, 3), 16),
                g: parseInt(hex.slice(3, 5), 16),
                b: parseInt(hex.slice(5, 7), 16)
            },
            luminance: parseFloat(relativeLuminance(hex).toFixed(4))
        })),
        combinations: combos.map((c, i) => ({
            id: i + 1,
            background: {
                hex: c.bg,
                name: names.get(c.bg)
            },
            text: {
                hex: c.text,
                name: names.get(c.text)
            },
            wcag: {
                ratio: parseFloat(c.ratio.toFixed(2)),
                level: c.level,
                passes_aa: c.level === 'AA' || c.level === 'AAA',
                passes_aaa: c.level === 'AAA'
            }
        }))
    };

    return JSON.stringify(data, null, 2);
}

// ── RENDER DE CÓDIGO ─────────────────────────────────────────────

function renderExportCode() {
    const combos = getAccessibleCombos();

    // Generar cada formato
    const css = generateCSS(combos);
    const tailwind = generateTailwind(combos);
    const figma = generateFigma(combos);
    const json = generateJSON(combos);

    // Render con syntax highlighting simple
    document.getElementById('code-css').innerHTML = 
        combos.length === 0 
        ? '<div class="empty-state"><span class="empty-state-icon">📋</span>Audita colores arriba para generar CSS</div>'
        : `<pre>${escapeHTML(css)}</pre>`;

    document.getElementById('code-tailwind').innerHTML = 
        combos.length === 0 
        ? '<div class="empty-state"><span class="empty-state-icon">🎨</span>Audita colores arriba para generar Tailwind config</div>'
        : `<pre>${highlightJS(tailwind)}</pre>`;

    document.getElementById('code-figma').innerHTML = 
        combos.length === 0 
        ? '<div class="empty-state"><span class="empty-state-icon">🎨</span>Audita colores arriba para generar tokens Figma</div>'
        : `<pre>${highlightJSON(figma)}</pre>`;

    document.getElementById('code-json').innerHTML = 
        combos.length === 0 
        ? '<div class="empty-state"><span class="empty-state-icon">🔧</span>Audita colores arriba para generar JSON</div>'
        : `<pre>${highlightJSON(json)}</pre>`;
}

function escapeHTML(str) {
    return str.replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m]);
}

function highlightJS(code) {
    return escapeHTML(code)
        .replace(/(\/\/.*)/g, '<span class="code-comment">$1</span>')
        .replace(/(['"])(.*?)\1/g, '<span class="code-string">$1$2$1</span>')
        .replace(/\b(\d+)\b/g, '<span class="code-number">$1</span>');
}

function highlightJSON(code) {
    return escapeHTML(code)
        .replace(/(".*?")(\s*:)/g, '<span class="code-key">$1</span>$2')
        .replace(/:\s*(".*?")/g, ': <span class="code-string">$1</span>')
        .replace(/:\s*(\d+\.?\d*)/g, ': <span class="code-number">$1</span>');
}

// ── COPIAR AL PORTAPAPELES ───────────────────────────────────────

document.querySelectorAll('.btn-copy').forEach(btn => {
    btn.addEventListener('click', async () => {
        const targetId = btn.dataset.target;
        const codeEl = document.getElementById(targetId);
        const text = codeEl.querySelector('pre')?.textContent || '';
        
        if (!text || text.includes('Audita colores')) return;

        try {
            await navigator.clipboard.writeText(text);
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span>✓</span> COPIADO';
            btn.classList.add('copied');
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('copied');
            }, 2000);
        } catch (err) {
            console.error('Error al copiar:', err);
        }
    });
});

// ── DESCARGAR ARCHIVO ────────────────────────────────────────────

document.querySelectorAll('.btn-download').forEach(btn => {
    btn.addEventListener('click', () => {
        const format = btn.dataset.format;
        const combos = getAccessibleCombos();
        if (combos.length === 0) return;

        let content, filename, mime;

        if (format === 'css') {
            content = generateCSS(combos);
            filename = 'accessible-colors.css';
            mime = 'text/css';
        } else if (format === 'tailwind') {
            content = generateTailwind(combos);
            filename = 'tailwind.config.js';
            mime = 'text/javascript';
        } else if (format === 'figma') {
            content = generateFigma(combos);
            filename = 'figma-tokens.json';
            mime = 'application/json';
        } else if (format === 'json') {
            content = generateJSON(combos);
            filename = 'color-system.json';
            mime = 'application/json';
        }

        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    });
});

// ── TABS DE EXPORT ───────────────────────────────────────────────

document.querySelectorAll('.export-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.export-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.export-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('export-' + tab.dataset.export).classList.add('active');
    });
});

// ── INICIALIZAR PUNTO 3 ──────────────────────────────────────────

// Regenerar exports cada vez que cambia la auditoría WCAG
const originalRunWcagAudit = runWcagAudit;
runWcagAudit = function() {
    originalRunWcagAudit();
    renderExportCode();
};

// Render inicial
window.addEventListener('load', () => {
    setTimeout(() => { renderExportCode(); }, 200);
});

// ================================================================
// PUNTO 4 — MEMORIA Y COMPARACIÓN
// Sistema de historial con localStorage + comparador de versiones
// ================================================================

const STORAGE_KEY = 'color-palette-history';
const MAX_HISTORY = 10;
let paletteHistory = [];
let selectedForCompare = [];

// ── LOCALSTORAGE ─────────────────────────────────────────────────

function loadHistory() {
    try {
        const stored = localStorage.getItem(STORAGE_KEY);
        paletteHistory = stored ? JSON.parse(stored) : [];
    } catch (e) {
        console.error('Error cargando historial:', e);
        paletteHistory = [];
    }
}

function saveHistory() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(paletteHistory));
    } catch (e) {
        console.error('Error guardando historial:', e);
    }
}

// ── GUARDAR PALETA ACTUAL ────────────────────────────────────────

function savePalette() {
    const nameInput = document.getElementById('palette-name-input');
    const name = nameInput.value.trim() || `Paleta ${new Date().toLocaleString('es-MX')}`;
    
    if (brandPalette.length < 2) {
        alert('Necesitas al menos 2 colores en la paleta para guardar.');
        return;
    }

    // Calcular stats WCAG de esta paleta
    const combos = getAccessibleCombos();
    const stats = {
        total: brandPalette.length,
        accessible: combos.length,
        aa: combos.filter(c => c.level === 'AA' || c.level === 'AAA').length,
        aaa: combos.filter(c => c.level === 'AAA').length
    };

    const entry = {
        id: Date.now(),
        name,
        timestamp: new Date().toISOString(),
        colors: [...brandPalette],
        stats
    };

    // Agregar al inicio del historial
    paletteHistory.unshift(entry);
    
    // Limitar a MAX_HISTORY
    if (paletteHistory.length > MAX_HISTORY) {
        paletteHistory = paletteHistory.slice(0, MAX_HISTORY);
    }

    saveHistory();
    renderHistory();
    
    // Limpiar input
    nameInput.value = '';
    
    // Feedback visual
    const btn = document.getElementById('btn-save-palette');
    const origText = btn.innerHTML;
    btn.innerHTML = '✓ GUARDADA';
    setTimeout(() => { btn.innerHTML = origText; }, 2000);
}

// ── RENDER HISTORIAL ─────────────────────────────────────────────

function renderHistory() {
    const container = document.getElementById('history-list-container');
    
    if (paletteHistory.length === 0) {
        container.innerHTML = `
            <div class="history-empty">
                <span style="font-size:2rem;display:block;margin-bottom:0.5rem;opacity:0.4">📦</span>
                Aún no hay paletas guardadas.<br>
                Configura colores arriba y presiona "Guardar paleta actual".
            </div>`;
        document.getElementById('compare-section').style.display = 'none';
        return;
    }

    // Mostrar sección de comparador
    document.getElementById('compare-section').style.display = 'block';

    const html = paletteHistory.map(entry => {
        const date = new Date(entry.timestamp);
        const dateStr = date.toLocaleDateString('es-MX', { 
            year: 'numeric', month: 'short', day: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
        
        const isSelected = selectedForCompare.includes(entry.id);
        
        return `
            <div class="history-item ${isSelected ? 'selected' : ''}" data-id="${entry.id}">
                <div class="history-info">
                    <div class="history-name">${escapeHTML(entry.name)}</div>
                    <div class="history-meta">
                        <span>📅 ${dateStr}</span>
                        <span>🎨 ${entry.stats.total} colores</span>
                        <span>✓ ${entry.stats.accessible} accesibles</span>
                        ${entry.stats.aaa > 0 ? `<span style="color:var(--accent)">AAA: ${entry.stats.aaa}</span>` : ''}
                    </div>
                </div>
                <div class="history-swatches">
                    ${entry.colors.map(c => `<div class="history-swatch" style="background:${c}"></div>`).join('')}
                </div>
                <div class="history-actions">
                    <button class="btn-history btn-load" data-id="${entry.id}">↑ Cargar</button>
                    <button class="btn-history btn-select" data-id="${entry.id}">
                        ${isSelected ? '✓ Selec.' : 'Comparar'}
                    </button>
                    <button class="btn-history danger btn-delete" data-id="${entry.id}">🗑</button>
                </div>
            </div>`;
    }).join('');

    container.innerHTML = `<div class="history-list">${html}</div>`;

    // Event listeners
    container.querySelectorAll('.btn-load').forEach(btn => {
        btn.addEventListener('click', () => loadPalette(parseInt(btn.dataset.id)));
    });

    container.querySelectorAll('.btn-select').forEach(btn => {
        btn.addEventListener('click', () => toggleSelect(parseInt(btn.dataset.id)));
    });

    container.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', () => {
            if (confirm('¿Eliminar esta paleta del historial?')) {
                deletePalette(parseInt(btn.dataset.id));
            }
        });
    });
}

// ── OPERACIONES SOBRE PALETAS ────────────────────────────────────

function loadPalette(id) {
    const entry = paletteHistory.find(e => e.id === id);
    if (!entry) return;
    
    brandPalette = [...entry.colors];
    runWcagAudit();
    
    // Scroll al auditor
    document.querySelector('.wcag-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function deletePalette(id) {
    paletteHistory = paletteHistory.filter(e => e.id !== id);
    selectedForCompare = selectedForCompare.filter(sid => sid !== id);
    saveHistory();
    renderHistory();
    updateCompareButton();
}

function toggleSelect(id) {
    if (selectedForCompare.includes(id)) {
        selectedForCompare = selectedForCompare.filter(sid => sid !== id);
    } else {
        // Máximo 2 para comparar
        if (selectedForCompare.length >= 2) {
            selectedForCompare.shift(); // quitar el primero
        }
        selectedForCompare.push(id);
    }
    renderHistory();
    updateCompareButton();
}

function updateCompareButton() {
    const btn = document.getElementById('btn-run-compare');
    btn.disabled = selectedForCompare.length !== 2;
    btn.textContent = selectedForCompare.length === 2 
        ? '⚖ COMPARAR SELECCIONADAS' 
        : `⚖ Selecciona 2 paletas (${selectedForCompare.length}/2)`;
}

// ── COMPARADOR ───────────────────────────────────────────────────

function runComparison() {
    if (selectedForCompare.length !== 2) return;

    const [id1, id2] = selectedForCompare;
    const p1 = paletteHistory.find(e => e.id === id1);
    const p2 = paletteHistory.find(e => e.id === id2);

    if (!p1 || !p2) return;

    // Generar combinaciones accesibles de cada paleta
    const c1 = getAccessibleCombosForPalette(p1.colors);
    const c2 = getAccessibleCombosForPalette(p2.colors);

    // Comparación de métricas
    const diffs = [];
    
    if (c1.length > c2.length) {
        diffs.push(`<span class="diff-improve">✓ ${p1.name}</span> tiene ${c1.length - c2.length} combinaciones accesibles más`);
    } else if (c2.length > c1.length) {
        diffs.push(`<span class="diff-improve">✓ ${p2.name}</span> tiene ${c2.length - c1.length} combinaciones accesibles más`);
    } else {
        diffs.push(`<span class="diff-same">Ambas tienen ${c1.length} combinaciones accesibles</span>`);
    }

    const aaa1 = c1.filter(c => c.level === 'AAA').length;
    const aaa2 = c2.filter(c => c.level === 'AAA').length;
    if (aaa1 > aaa2) {
        diffs.push(`<span class="diff-improve">✓ ${p1.name}</span> tiene ${aaa1 - aaa2} combinaciones AAA más`);
    } else if (aaa2 > aaa1) {
        diffs.push(`<span class="diff-improve">✓ ${p2.name}</span> tiene ${aaa2 - aaa1} combinaciones AAA más`);
    }

    // Promedio de ratios
    const avg1 = c1.length > 0 ? c1.reduce((sum, c) => sum + c.ratio, 0) / c1.length : 0;
    const avg2 = c2.length > 0 ? c2.reduce((sum, c) => sum + c.ratio, 0) / c2.length : 0;
    if (avg1 > avg2) {
        diffs.push(`<span class="diff-improve">✓ ${p1.name}</span> tiene mejor ratio promedio: ${avg1.toFixed(2)} vs ${avg2.toFixed(2)}`);
    } else if (avg2 > avg1) {
        diffs.push(`<span class="diff-improve">✓ ${p2.name}</span> tiene mejor ratio promedio: ${avg2.toFixed(2)} vs ${avg1.toFixed(2)}`);
    }

    // Colores únicos vs compartidos
    const shared = p1.colors.filter(c => p2.colors.includes(c));
    if (shared.length > 0) {
        diffs.push(`<span class="diff-same">${shared.length} colores compartidos</span>`);
    }

    const html = `
        <div class="compare-grid">
            <div class="compare-col">
                <h4>Versión A</h4>
                <div class="compare-name">${escapeHTML(p1.name)}</div>
                <div class="compare-swatches">
                    ${p1.colors.map(c => `<div class="history-swatch" style="background:${c}"></div>`).join('')}
                </div>
                <div class="compare-stat">
                    🎨 <strong>${p1.stats.total}</strong> colores<br>
                    ✓ <strong>${p1.stats.accessible}</strong> combinaciones accesibles<br>
                    ◉ <strong>${aaa1}</strong> nivel AAA<br>
                    📊 Ratio promedio: <strong>${avg1.toFixed(2)}:1</strong>
                </div>
            </div>
            <div class="compare-col">
                <h4>Versión B</h4>
                <div class="compare-name">${escapeHTML(p2.name)}</div>
                <div class="compare-swatches">
                    ${p2.colors.map(c => `<div class="history-swatch" style="background:${c}"></div>`).join('')}
                </div>
                <div class="compare-stat">
                    🎨 <strong>${p2.stats.total}</strong> colores<br>
                    ✓ <strong>${p2.stats.accessible}</strong> combinaciones accesibles<br>
                    ◉ <strong>${aaa2}</strong> nivel AAA<br>
                    📊 Ratio promedio: <strong>${avg2.toFixed(2)}:1</strong>
                </div>
            </div>
        </div>
        <div class="compare-diff">
            <h4>// análisis de diferencias</h4>
            ${diffs.map(d => `<div class="diff-row">${d}</div>`).join('')}
        </div>
    `;

    document.getElementById('compare-result').innerHTML = html;
}

function getAccessibleCombosForPalette(palette) {
    const combos = [];
    for (let i = 0; i < palette.length; i++) {
        for (let j = 0; j < palette.length; j++) {
            if (i === j) continue;
            const bg = palette[i], text = palette[j];
            const ratio = contrastRatio(bg, text);
            const level = wcagLevel(ratio);
            if (level === 'AA' || level === 'AAA') {
                combos.push({ bg, text, ratio, level });
            }
        }
    }
    return combos;
}

// ── EVENTOS ──────────────────────────────────────────────────────

document.getElementById('btn-save-palette').addEventListener('click', savePalette);
document.getElementById('btn-run-compare').addEventListener('click', runComparison);

// Permitir Enter en el input de nombre
document.getElementById('palette-name-input').addEventListener('keypress', e => {
    if (e.key === 'Enter') savePalette();
});

// ── INICIALIZAR PUNTO 4 ──────────────────────────────────────────

loadHistory();
renderHistory();
updateCompareButton();

// ================================================================
// PUNTO 5 — EXPLICACIÓN DIFUSA COMO VENTAJA VISIBLE
// Traduce decisiones técnicas a lenguaje de cliente/diseñador
// ================================================================

let explanationVisible = false;

// ── TOGGLE VISIBILITY ────────────────────────────────────────────

document.getElementById('btn-toggle-explain').addEventListener('click', () => {
    explanationVisible = !explanationVisible;
    const box = document.getElementById('explanation-box');
    const btn = document.getElementById('btn-toggle-explain');
    
    if (explanationVisible) {
        box.classList.add('visible');
        btn.classList.add('active');
        btn.textContent = '👁 OCULTAR ANÁLISIS';
        renderExplanation();
    } else {
        box.classList.remove('visible');
        btn.classList.remove('active');
        btn.textContent = '👁 MOSTRAR ANÁLISIS';
    }
});

// ── GENERAR EXPLICACIONES ────────────────────────────────────────

function renderExplanation() {
    const hex = document.getElementById('color-input').value;
    const bigint = parseInt(hex.slice(1), 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8)  & 255;
    const b = bigint & 255;

    // Recalcular lógica difusa
    const fz = fuzzyInference(r, g, b);
    const nnResult = network.run({ r: r/255, g: g/255, b: b/255 });
    const nnCrisp  = nnResult.c;
    const combined = 0.4 * nnCrisp + 0.6 * fz.crisp;

    // ── DECISIÓN PRINCIPAL ──
    const textColor = combined > 0.5 ? 'BLANCO' : 'NEGRO';
    const lumaPct = (fz.luma * 100).toFixed(1);
    
    let mainExplanation = `Para el color <strong style="color:${hex}">${hex}</strong>, el sistema recomienda texto <strong>${textColor}</strong>.<br><br>`;
    
    // Explicar dominancia de conjuntos difusos
    const dominantSet = fz.mDark > Math.max(fz.mMid, fz.mLight) ? 'OSCURO' 
                      : fz.mLight > fz.mMid ? 'CLARO' 
                      : 'GRIS MEDIO';
    
    const dominantMembership = Math.max(fz.mDark, fz.mMid, fz.mLight);
    
    mainExplanation += `<strong>Análisis de luminosidad:</strong><br>`;
    mainExplanation += `<ul>`;
    mainExplanation += `<li>Luminancia perceptual: <strong>${lumaPct}%</strong> (0-100 escala)</li>`;
    mainExplanation += `<li>Pertenencia al conjunto "<strong>${dominantSet}</strong>": ${(dominantMembership * 100).toFixed(0)}%</li>`;
    mainExplanation += `<li>Grados de membresía: Oscuro=${(fz.mDark*100).toFixed(0)}%, Medio=${(fz.mMid*100).toFixed(0)}%, Claro=${(fz.mLight*100).toFixed(0)}%</li>`;
    mainExplanation += `</ul><br>`;
    
    // Saturación y tono
    const satLevel = fz.mSat > fz.mNeut ? 'SATURADO' : 'NEUTRO';
    const toneLevel = fz.mCool > Math.max(fz.mWarm, fz.mTNeu) ? 'FRÍO (azul/verde)' 
                    : fz.mWarm > fz.mTNeu ? 'CÁLIDO (rojo/amarillo)' 
                    : 'NEUTRO (sin tono dominante)';
    
    mainExplanation += `<strong>Características de color:</strong><br>`;
    mainExplanation += `<ul>`;
    mainExplanation += `<li>Saturación: <strong>${satLevel}</strong> (${(fz.hsl.s * 100).toFixed(0)}%)</li>`;
    mainExplanation += `<li>Tono: <strong>${toneLevel}</strong> (matiz ${fz.h.toFixed(0)}°)</li>`;
    mainExplanation += `</ul>`;
    
    document.getElementById('explain-main-body').innerHTML = mainExplanation;
    
    // ── VENTAJA ESPECÍFICA ──
    let advantage = '';
    if (Math.abs(fz.luma - 0.5) < 0.15) {
        // Zona gris
        advantage = `Este color está en la <strong>zona gris crítica</strong> (luma ~50%). Una regla binaria simple fallaría aquí, 
                    alternando bruscamente entre blanco y negro. La lógica difusa evalúa <strong>múltiples reglas simultáneamente</strong>: 
                    considera la saturación (${(fz.mSat*100).toFixed(0)}% saturado) y el tono (${toneLevel.toLowerCase()}) para tomar 
                    una decisión más inteligente. Por ejemplo, un gris medio saturado y frío necesita texto diferente que un gris neutro.`;
    } else if (fz.mSat > 0.7 && fz.luma > 0.4 && fz.luma < 0.6) {
        // Color saturado en zona media
        advantage = `Este es un <strong>color corporativo típicamente problemático</strong>: saturación alta (${(fz.mSat*100).toFixed(0)}%) 
                    con luminosidad media. La lógica difusa detecta que aunque la luminancia está en zona ambigua, 
                    la <strong>combinación de saturación + tono ${toneLevel.toLowerCase()}</strong> requiere tratamiento especial. 
                    Las reglas R5 y R6 del sistema evalúan específicamente estos casos.`;
    } else {
        advantage = `La lógica difusa permite decisiones <strong>graduales y matizadas</strong>. En lugar de "si luma > 0.5 → blanco", 
                    el sistema pondera ${fz.rules.filter(r => r.mu > 0.05).length} reglas activas simultáneamente, 
                    cada una contribuyendo proporcionalmente a su grado de activación. El resultado final es un 
                    promedio ponderado (centroide) de todas las reglas, no una decisión abrupta.`;
    }
    document.getElementById('explain-advantage').innerHTML = advantage;
    
    // ── COMPARACIÓN MÉTODOS ──
    document.getElementById('nn-value').textContent = nnCrisp.toFixed(3);
    document.getElementById('fuzzy-value').textContent = fz.crisp.toFixed(3);
    
    const diff = Math.abs(nnCrisp - fz.crisp);
    if (diff > 0.15) {
        document.getElementById('nn-desc').innerHTML = 
            `La red neuronal predice <strong>${nnCrisp > 0.5 ? 'BLANCO' : 'NEGRO'}</strong>. 
            Difiere significativamente de la lógica difusa (Δ=${diff.toFixed(2)}) porque aprendió de ejemplos históricos, 
            no de reglas explícitas. Puede ser más conservadora o arriesgada según su entrenamiento.`;
        
        document.getElementById('fuzzy-desc').innerHTML = 
            `La lógica difusa predice <strong>${fz.crisp > 0.5 ? 'BLANCO' : 'NEGRO'}</strong> basándose en reglas transparentes. 
            ${fz.rules.filter(r => r.mu > 0.05).length} reglas están activas, 
            siendo la más fuerte "${fz.rules.sort((a,b) => b.mu - a.mu)[0].label}" con μ=${fz.rules.sort((a,b) => b.mu - a.mu)[0].mu.toFixed(2)}.`;
    } else {
        document.getElementById('nn-desc').innerHTML = 
            `Ambos métodos coinciden (Δ=${diff.toFixed(2)}). La red neuronal aprendió patrones similares a las reglas difusas 
            durante su entrenamiento con 20 ejemplos etiquetados.`;
        
        document.getElementById('fuzzy-desc').innerHTML = 
            `Coincide con la red neuronal. Las reglas difusas formalizan el conocimiento experto sobre 
            cuándo usar texto claro u oscuro según características del color.`;
    }
    
    // ── CASOS ESPECIALES ──
    const specialContainer = document.getElementById('special-case-container');
    let specialHTML = '';
    
    // Azul corporativo problemático
    if (fz.h >= 200 && fz.h <= 240 && fz.luma > 0.2 && fz.luma < 0.5 && fz.mSat > 0.5) {
        specialHTML = `
            <div class="explain-special-case">
                <div class="explain-special-case-title">
                    <span>⚠️</span>
                    <span>CASO ESPECIAL: Azul Corporativo</span>
                </div>
                <div class="explain-special-case-body">
                    Este azul está en el rango típico de "azules corporativos" (H=${fz.h.toFixed(0)}°, Luma=${lumaPct}%). 
                    <strong>Problema común:</strong> muchas marcas usan estos azules pensando que son "profesionales", 
                    pero luego fallan WCAG con texto blanco. El sistema detecta que aunque visualmente parece oscuro, 
                    la luminancia real es ${lumaPct}%, requiriendo texto blanco para contraste adecuado. 
                    <strong>Solución:</strong> oscurecer el azul a luma &lt;40% o usar este azul solo para acentos, 
                    no fondos de texto.
                </div>
            </div>`;
    }
    // Amarillo/verde claro problemático
    else if ((fz.h >= 45 && fz.h <= 150) && fz.luma > 0.7 && fz.mSat > 0.6) {
        specialHTML = `
            <div class="explain-special-case">
                <div class="explain-special-case-title">
                    <span>⚠️</span>
                    <span>CASO ESPECIAL: Amarillo/Verde Vibrante</span>
                </div>
                <div class="explain-special-case-body">
                    Los amarillos y verdes claros son <strong>engañosos visualmente</strong>. Aunque parecen "brillantes", 
                    su alta luminancia (${lumaPct}%) los hace fondos excelentes para texto negro. 
                    Muchos diseñadores erróneamente ponen texto blanco sobre amarillo brillante y fallan WCAG catastróficamente. 
                    La lógica difusa detecta la combinación de alto luma + saturación y recomienda negro correctamente.
                </div>
            </div>`;
    }
    // Gris medio sin salida
    else if (fz.mNeut > 0.7 && fz.luma > 0.35 && fz.luma < 0.65) {
        specialHTML = `
            <div class="explain-special-case">
                <div class="explain-special-case-title">
                    <span>⚠️</span>
                    <span>CASO ESPECIAL: Gris Medio Neutro</span>
                </div>
                <div class="explain-special-case-body">
                    Este gris está en la <strong>zona imposible</strong> (luma ${lumaPct}%, saturación casi nula). 
                    Ni texto blanco ni negro lograrán contraste WCAG AAA. Máximo podrás alcanzar AA con cuidado. 
                    <strong>Recomendación:</strong> evita este gris como fondo de texto. Úsalo solo para bordes, 
                    divisores, o elementos no textuales. Si necesitas usarlo, considera agregar un outline al texto 
                    para mejorar legibilidad (aunque no cuenta para WCAG oficial).
                </div>
            </div>`;
    }
    
    specialContainer.innerHTML = specialHTML;
}

// ── GENERAR REPORTE PARA CLIENTE ─────────────────────────────────

document.getElementById('btn-generate-report').addEventListener('click', () => {
    const hex = document.getElementById('color-input').value;
    const bigint = parseInt(hex.slice(1), 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8)  & 255;
    const b = bigint & 255;
    
    const fz = fuzzyInference(r, g, b);
    const nnResult = network.run({ r: r/255, g: g/255, b: b/255 });
    const combined = 0.4 * nnResult.c + 0.6 * fz.crisp;
    
    // Generar HTML del reporte
    let report = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte de Accesibilidad de Color - ${hex}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.7;
            color: #1a1a1a;
        }
        .header {
            border-bottom: 3px solid #b0ff4b;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        h1 { color: #0d0d0f; margin: 0 0 10px; }
        .subtitle { color: #666; font-size: 0.9rem; }
        .color-display {
            background: ${hex};
            color: ${combined > 0.5 ? '#ffffff' : '#000000'};
            padding: 40px;
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            border-radius: 12px;
            margin: 30px 0;
        }
        .section {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .section h2 {
            margin-top: 0;
            color: #0d0d0f;
            font-size: 1.2rem;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-weight: 600; }
        .metric-value { color: #666; }
        .recommendation {
            background: linear-gradient(135deg, rgba(176,255,75,0.15), rgba(75,255,236,0.15));
            border-left: 4px solid #b0ff4b;
            padding: 20px;
            margin: 30px 0;
            border-radius: 0 8px 8px 0;
        }
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 0.85rem;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📊 Reporte de Análisis de Color</h1>
        <div class="subtitle">
            Fuzzy Logic Engine + Neural Network<br>
            ChromaAudit · Color Intelligence Platform
        </div>
    </div>
    
    <div class="color-display">
        ${hex.toUpperCase()}<br>
        <span style="font-size:1rem">Texto de ejemplo</span>
    </div>
    
    <div class="section">
        <h2>Análisis Técnico</h2>
        <div class="metric">
            <span class="metric-label">Color analizado:</span>
            <span class="metric-value">${hex.toUpperCase()}</span>
        </div>
        <div class="metric">
            <span class="metric-label">RGB:</span>
            <span class="metric-value">R=${r}, G=${g}, B=${b}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Luminancia perceptual:</span>
            <span class="metric-value">${(fz.luma * 100).toFixed(1)}%</span>
        </div>
        <div class="metric">
            <span class="metric-label">Saturación:</span>
            <span class="metric-value">${(fz.hsl.s * 100).toFixed(0)}%</span>
        </div>
        <div class="metric">
            <span class="metric-label">Matiz (tono):</span>
            <span class="metric-value">${fz.h.toFixed(0)}°</span>
        </div>
    </div>
    
    <div class="section">
        <h2>Decisión del Sistema</h2>
        <div class="metric">
            <span class="metric-label">Color de texto recomendado:</span>
            <span class="metric-value"><strong>${combined > 0.5 ? 'BLANCO (#FFFFFF)' : 'NEGRO (#000000)'}</strong></span>
        </div>
        <div class="metric">
            <span class="metric-label">Confianza (lógica difusa):</span>
            <span class="metric-value">${(Math.abs(fz.crisp - 0.5) * 200).toFixed(0)}%</span>
        </div>
        <div class="metric">
            <span class="metric-label">Red neuronal coincide:</span>
            <span class="metric-value">${Math.abs(nnResult.c - fz.crisp) < 0.15 ? 'SÍ' : 'NO (ver detalles)'}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Reglas difusas activas:</span>
            <span class="metric-value">${fz.rules.filter(r => r.mu > 0.05).length} de 12</span>
        </div>
    </div>
    
    <div class="recommendation">
        <h2 style="margin-top:0">💡 Recomendación para tu marca</h2>
        <p><strong>Color de texto:</strong> Usa ${combined > 0.5 ? 'texto blanco (#FFFFFF)' : 'texto negro (#000000)'} 
        sobre este fondo para garantizar legibilidad.</p>
        
        <p><strong>Verificación WCAG:</strong> El contraste resultante con ${combined > 0.5 ? 'blanco' : 'negro'} es 
        ${contrastRatio(hex, combined > 0.5 ? '#FFFFFF' : '#000000').toFixed(2)}:1. 
        ${contrastRatio(hex, combined > 0.5 ? '#FFFFFF' : '#000000') >= 7 ? 'Cumple AAA ✅ (óptimo)' 
        : contrastRatio(hex, combined > 0.5 ? '#FFFFFF' : '#000000') >= 4.5 ? 'Cumple AA ✓ (aceptable)' 
        : 'No cumple WCAG ⚠️ (requiere ajuste)'}
        </p>
        
        <p><strong>Explicación técnica:</strong> El sistema analizó la luminosidad perceptual (${(fz.luma*100).toFixed(1)}%), 
        saturación (${(fz.hsl.s*100).toFixed(0)}%) y temperatura de color. La lógica difusa evaluó 12 reglas simultáneamente, 
        ponderando cada una según su grado de activación. Este enfoque permite decisiones más precisas que un simple umbral 
        de luminosidad.</p>
    </div>
    
    <div class="footer">
        ChromaAudit · Color Intelligence Platform<br>
        Generated on ${new Date().toLocaleDateString('es-MX')}
    </div>
</body>
</html>`;

    // Descargar como HTML
    const blob = new Blob([report], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `reporte-color-${hex.replace('#','')}.html`;
    a.click();
    URL.revokeObjectURL(url);
});

// ── AUTO-ACTUALIZAR EXPLICACIÓN ──────────────────────────────────

// Envolver la función update original para actualizar explicación
const originalUpdate = update;
update = function() {
    originalUpdate();
    if (explanationVisible) {
        renderExplanation();
    }
};

// ================================================================
// PUNTO 5B — REPORTES DE PALETA EXTRAÍDA
// Análisis completo de paletas de URL e Imagen con lógica difusa
// ================================================================

// ── ANÁLISIS DE COLOR INDIVIDUAL ─────────────────────────────────

function analyzeColor(hex) {
    const bigint = parseInt(hex.slice(1), 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8)  & 255;
    const b = bigint & 255;
    
    const fz = fuzzyInference(r, g, b);
    const lumaRel = relativeLuminance(hex);
    
    // Clasificar rol según luma
    let role = '';
    if (lumaRel < 0.25)      role = 'Fondo oscuro';
    else if (lumaRel < 0.45) role = 'Fondo medio/acento oscuro';
    else if (lumaRel < 0.65) role = 'Zona ambigua';
    else if (lumaRel < 0.85) role = 'Acento claro';
    else                     role = 'Fondo claro';
    
    // Temperatura
    let temp = fz.mCool > Math.max(fz.mWarm, fz.mTNeu) ? 'Frío' 
             : fz.mWarm > fz.mTNeu ? 'Cálido' 
             : 'Neutro';
    
    // Contraste con blanco y negro
    const contrastWhite = contrastRatio(hex, '#FFFFFF');
    const contrastBlack = contrastRatio(hex, '#000000');
    
    const bestTextColor = contrastWhite > contrastBlack ? '#FFFFFF' : '#000000';
    const bestContrast = Math.max(contrastWhite, contrastBlack);
    
    let wcagLevel = 'Ninguno';
    if (bestContrast >= 7.0)  wcagLevel = 'AAA';
    else if (bestContrast >= 4.5) wcagLevel = 'AA';
    else if (bestContrast >= 3.0) wcagLevel = 'AA Grande';
    
    return {
        hex, r, g, b,
        luma: fz.luma,
        saturation: fz.hsl.s,
        hue: fz.h,
        role, temp,
        bestTextColor,
        bestContrast,
        wcagLevel,
        contrastWhite,
        contrastBlack,
        fuzzy: fz
    };
}

// ── DIAGNÓSTICO DE PALETA ────────────────────────────────────────

function diagnosePalette(colors) {
    const analyzed = colors.map(c => analyzeColor(c));
    
    // Balance frío/cálido
    const cool = analyzed.filter(a => a.temp === 'Frío').length;
    const warm = analyzed.filter(a => a.temp === 'Cálido').length;
    const neutral = analyzed.filter(a => a.temp === 'Neutro').length;
    
    let tempBalance = '';
    if (cool > warm * 2) tempBalance = 'Predominantemente fría';
    else if (warm > cool * 2) tempBalance = 'Predominantemente cálida';
    else tempBalance = 'Balanceada';
    
    // Rango de luminosidad
    const lumas = analyzed.map(a => a.luma);
    const minLuma = Math.min(...lumas);
    const maxLuma = Math.max(...lumas);
    const spread = maxLuma - minLuma;
    
    let lumaAssessment = '';
    if (spread < 0.3) lumaAssessment = 'Rango muy estrecho — falta contraste';
    else if (spread < 0.6) lumaAssessment = 'Rango medio — podría mejorarse';
    else lumaAssessment = 'Rango amplio — buen contraste potencial';
    
    // Colores seguros vs problemáticos
    const safe = analyzed.filter(a => a.wcagLevel === 'AA' || a.wcagLevel === 'AAA').length;
    const problem = analyzed.length - safe;
    
    // Gaps problemáticos
    const gaps = [];
    if (!analyzed.some(a => a.luma > 0.4 && a.luma < 0.6)) {
        gaps.push('No hay tonos medios — salto abrupto de oscuro a claro');
    }
    if (analyzed.every(a => a.saturation < 0.3)) {
        gaps.push('Paleta muy desaturada — considera agregar un acento vibrante');
    }
    if (analyzed.every(a => a.saturation > 0.6)) {
        gaps.push('Todos los colores muy saturados — difícil encontrar fondos neutros');
    }
    
    return {
        tempBalance,
        coolCount: cool,
        warmCount: warm,
        neutralCount: neutral,
        lumaRange: { min: minLuma, max: maxLuma, spread },
        lumaAssessment,
        safeCount: safe,
        problemCount: problem,
        gaps
    };
}

// ── GENERAR REPORTE HTML DE URL ──────────────────────────────────

function generateURLPaletteReport(colors, sourceURL) {
    const analyzed = colors.map(c => analyzeColor(c));
    const diagnosis = diagnosePalette(colors);
    
    const colorRows = analyzed.map(a => `
        <tr>
            <td style="text-align:center;padding:8px;">
                <div style="width:50px;height:50px;background:${a.hex};border-radius:8px;border:1px solid #ddd;margin:0 auto;"></div>
            </td>
            <td style="padding:8px;font-family:monospace;font-weight:bold;">${a.hex}</td>
            <td style="padding:8px;">${(a.luma * 100).toFixed(0)}%</td>
            <td style="padding:8px;">${(a.saturation * 100).toFixed(0)}%</td>
            <td style="padding:8px;">${a.temp}</td>
            <td style="padding:8px;">${a.role}</td>
            <td style="padding:8px;text-align:center;">
                <div style="background:${a.hex};color:${a.bestTextColor};padding:4px 8px;border-radius:4px;font-size:0.85rem;font-weight:bold;">
                    Aa
                </div>
            </td>
            <td style="padding:8px;font-weight:bold;">${a.bestContrast.toFixed(2)}:1</td>
            <td style="padding:8px;">
                <span style="display:inline-block;padding:3px 8px;border-radius:4px;font-size:0.75rem;font-weight:bold;
                      background:${a.wcagLevel === 'AAA' ? '#b0ff4b' : a.wcagLevel === 'AA' ? '#ffcc00' : '#ff4b4b'};
                      color:#000;">
                    ${a.wcagLevel}
                </span>
            </td>
        </tr>
    `).join('');
    
    const report = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Análisis de Paleta Extraída - ${sourceURL || 'URL'}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 1000px; margin: 40px auto; padding: 20px; line-height: 1.6; color: #1a1a1a; }
        .header { border-bottom: 3px solid #4bffec; padding-bottom: 20px; margin-bottom: 30px; }
        h1 { color: #0d0d0f; margin: 0 0 10px; }
        .subtitle { color: #666; font-size: 0.9rem; }
        .source { background: #f0f0f0; padding: 10px 15px; border-radius: 6px; margin: 20px 0; font-family: monospace; font-size: 0.85rem; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #f8f8f8; padding: 12px 8px; text-align: left; font-size: 0.85rem; border-bottom: 2px solid #ddd; }
        td { border-bottom: 1px solid #eee; }
        .diagnosis { background: linear-gradient(135deg, rgba(176,255,75,0.1), rgba(75,255,236,0.1)); border-left: 4px solid #4bffec; padding: 20px; margin: 30px 0; border-radius: 0 8px 8px 0; }
        .diagnosis h2 { margin-top: 0; color: #0d0d0f; }
        .metric { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .metric:last-child { border-bottom: none; }
        .recommendations { background: #fff9e6; border-left: 4px solid #ffcc00; padding: 20px; margin: 20px 0; border-radius: 0 8px 8px 0; }
        .recommendations h2 { margin-top: 0; color: #0d0d0f; }
        .recommendations ul { margin: 10px 0; padding-left: 20px; }
        .recommendations li { margin: 8px 0; }
        .footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid #e0e0e0; text-align: center; font-size: 0.85rem; color: #999; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🌐 Análisis de Paleta Extraída de URL</h1>
        <div class="subtitle">Fuzzy Logic Engine · WCAG 2.1 audit<br>ChromaAudit · Color Intelligence Platform</div>
    </div>
    
    <div class="source">
        <strong>Origen:</strong> ${escapeHTML(sourceURL || 'URL proporcionada')}<br>
        <strong>Fecha:</strong> ${new Date().toLocaleString('es-MX')}<br>
        <strong>Colores encontrados:</strong> ${colors.length}
    </div>
    
    <h2>Tabla de Colores</h2>
    <table>
        <thead>
            <tr>
                <th>Vista</th>
                <th>Hex</th>
                <th>Luma</th>
                <th>Sat.</th>
                <th>Temp.</th>
                <th>Rol sugerido</th>
                <th>Mejor texto</th>
                <th>Contraste</th>
                <th>WCAG</th>
            </tr>
        </thead>
        <tbody>
            ${colorRows}
        </tbody>
    </table>
    
    <div class="diagnosis">
        <h2>📊 Diagnóstico de Paleta</h2>
        <div class="metric">
            <span><strong>Balance de temperatura:</strong></span>
            <span>${diagnosis.tempBalance} (${diagnosis.coolCount} fríos, ${diagnosis.warmCount} cálidos, ${diagnosis.neutralCount} neutros)</span>
        </div>
        <div class="metric">
            <span><strong>Rango de luminosidad:</strong></span>
            <span>${(diagnosis.lumaRange.min * 100).toFixed(0)}% - ${(diagnosis.lumaRange.max * 100).toFixed(0)}% (spread: ${(diagnosis.lumaRange.spread * 100).toFixed(0)}%)</span>
        </div>
        <div class="metric">
            <span><strong>Evaluación de contraste:</strong></span>
            <span>${diagnosis.lumaAssessment}</span>
        </div>
        <div class="metric">
            <span><strong>Colores seguros WCAG:</strong></span>
            <span>${diagnosis.safeCount} de ${colors.length} (${diagnosis.problemCount} requieren ajuste)</span>
        </div>
        ${diagnosis.gaps.length > 0 ? `
        <div style="margin-top:15px;">
            <strong>⚠️ Gaps identificados:</strong>
            <ul style="margin:8px 0;padding-left:20px;">
                ${diagnosis.gaps.map(g => `<li>${g}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
    </div>
    
    <div class="recommendations">
        <h2>💡 Recomendaciones</h2>
        <ul>
            ${diagnosis.problemCount > 0 ? `<li><strong>Colores problemáticos:</strong> ${diagnosis.problemCount} colores no alcanzan contraste WCAG AA con ningún texto. Considera oscurecerlos o usarlos solo como acentos, no fondos.</li>` : ''}
            ${diagnosis.lumaRange.spread < 0.5 ? `<li><strong>Ampliar rango:</strong> Tu paleta tiene poco contraste interno. Agrega un color muy oscuro (&lt;20% luma) y uno muy claro (&gt;80% luma) para más versatilidad.</li>` : ''}
            ${diagnosis.gaps.includes('No hay tonos medios — salto abrupto de oscuro a claro') ? `<li><strong>Tonos medios:</strong> Considera agregar un gris medio (40-60% luma) para elementos secundarios y bordes.</li>` : ''}
            ${diagnosis.coolCount === 0 && diagnosis.warmCount > 0 ? `<li><strong>Balance térmico:</strong> Paleta 100% cálida. Un acento frío (azul/cyan) podría dar respiro visual.</li>` : ''}
            ${diagnosis.warmCount === 0 && diagnosis.coolCount > 0 ? `<li><strong>Balance térmico:</strong> Paleta 100% fría. Un acento cálido (naranja/coral) podría agregar energía.</li>` : ''}
            <li><strong>Siguiente paso:</strong> Carga estos colores en el Auditor WCAG (botón en la herramienta) para ver todas las combinaciones posibles y exportar código listo para producción.</li>
        </ul>
    </div>
    
    <div class="footer">
        ChromaAudit · Color Intelligence Platform<br>
        Generated on ${new Date().toLocaleDateString('es-MX')}
    </div>
</body>
</html>`;

    return report;
}

// ── GENERAR REPORTE HTML DE IMAGEN ───────────────────────────────

function generateImagePaletteReport(clusters, totalPixels, imageName) {
    const analyzed = clusters.map(c => ({ ...analyzeColor(c.hex), percentage: (c.pct / totalPixels) * 100 }));
    const colors = clusters.map(c => c.hex);
    const diagnosis = diagnosePalette(colors);
    
    // Detectar esquema de color
    const hues = analyzed.map(a => a.hue);
    let colorScheme = 'Personalizado';
    if (analyzed.length <= 3) {
        const hueDiffs = [];
        for (let i = 0; i < hues.length - 1; i++) {
            let diff = Math.abs(hues[i] - hues[i+1]);
            if (diff > 180) diff = 360 - diff;
            hueDiffs.push(diff);
        }
        const avgDiff = hueDiffs.reduce((a,b) => a+b, 0) / hueDiffs.length;
        if (analyzed.every(a => a.saturation < 0.2)) colorScheme = 'Monocromático (grises)';
        else if (avgDiff < 30) colorScheme = 'Monocromático';
        else if (avgDiff < 60) colorScheme = 'Análogo';
        else if (avgDiff > 150) colorScheme = 'Complementario';
    }
    
    const colorRows = analyzed.map((a, i) => `
        <tr>
            <td style="text-align:center;padding:8px;">
                <div style="width:60px;height:60px;background:${a.hex};border-radius:8px;border:1px solid #ddd;margin:0 auto;"></div>
            </td>
            <td style="padding:8px;font-family:monospace;font-weight:bold;">${a.hex}</td>
            <td style="padding:8px;font-weight:bold;color:#4bffec;">${a.percentage.toFixed(1)}%</td>
            <td style="padding:8px;">${i === 0 ? 'Principal' : i === 1 ? 'Secundario' : 'Acento'}</td>
            <td style="padding:8px;">${(a.luma * 100).toFixed(0)}%</td>
            <td style="padding:8px;">${a.temp}</td>
            <td style="padding:8px;text-align:center;">
                <div style="background:${a.hex};color:${a.bestTextColor};padding:4px 8px;border-radius:4px;font-size:0.85rem;font-weight:bold;">
                    Aa
                </div>
            </td>
            <td style="padding:8px;font-weight:bold;">${a.bestContrast.toFixed(2)}:1</td>
            <td style="padding:8px;">
                <span style="display:inline-block;padding:3px 8px;border-radius:4px;font-size:0.75rem;font-weight:bold;
                      background:${a.wcagLevel === 'AAA' ? '#b0ff4b' : a.wcagLevel === 'AA' ? '#ffcc00' : '#ff4b4b'};
                      color:#000;">
                    ${a.wcagLevel}
                </span>
            </td>
        </tr>
    `).join('');
    
    // Calcular combinaciones WCAG posibles
    let accessibleCombos = 0;
    for (let i = 0; i < colors.length; i++) {
        for (let j = 0; j < colors.length; j++) {
            if (i === j) continue;
            const ratio = contrastRatio(colors[i], colors[j]);
            if (ratio >= 4.5) accessibleCombos++;
        }
    }
    
    const report = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Análisis de Paleta de Imagen - ${imageName || 'Imagen'}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 1000px; margin: 40px auto; padding: 20px; line-height: 1.6; color: #1a1a1a; }
        .header { border-bottom: 3px solid #b0ff4b; padding-bottom: 20px; margin-bottom: 30px; }
        h1 { color: #0d0d0f; margin: 0 0 10px; }
        .subtitle { color: #666; font-size: 0.9rem; }
        .source { background: #f0f0f0; padding: 10px 15px; border-radius: 6px; margin: 20px 0; font-family: monospace; font-size: 0.85rem; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #f8f8f8; padding: 12px 8px; text-align: left; font-size: 0.85rem; border-bottom: 2px solid #ddd; }
        td { border-bottom: 1px solid #eee; }
        .harmony { background: linear-gradient(135deg, rgba(176,255,75,0.1), rgba(75,255,236,0.1)); border-left: 4px solid #b0ff4b; padding: 20px; margin: 30px 0; border-radius: 0 8px 8px 0; }
        .harmony h2 { margin-top: 0; color: #0d0d0f; }
        .metric { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .metric:last-child { border-bottom: none; }
        .accessibility { background: #e6f7ff; border-left: 4px solid #4bffec; padding: 20px; margin: 20px 0; border-radius: 0 8px 8px 0; }
        .accessibility h2 { margin-top: 0; color: #0d0d0f; }
        .footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid #e0e0e0; text-align: center; font-size: 0.85rem; color: #999; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🖼 Análisis de Paleta Extraída de Imagen</h1>
        <div class="subtitle">K-Means clustering · Fuzzy Logic Engine · WCAG 2.1 audit<br>ChromaAudit · Color Intelligence Platform</div>
    </div>
    
    <div class="source">
        <strong>Imagen:</strong> ${escapeHTML(imageName || 'Imagen subida')}<br>
        <strong>Fecha:</strong> ${new Date().toLocaleString('es-MX')}<br>
        <strong>Colores extraídos:</strong> ${colors.length} (K-Means clustering)<br>
        <strong>Píxeles analizados:</strong> ${totalPixels.toLocaleString('es-MX')}
    </div>
    
    <h2>Colores Dominantes (ordenados por presencia)</h2>
    <table>
        <thead>
            <tr>
                <th>Vista</th>
                <th>Hex</th>
                <th>Presencia</th>
                <th>Rol</th>
                <th>Luma</th>
                <th>Temp.</th>
                <th>Mejor texto</th>
                <th>Contraste</th>
                <th>WCAG</th>
            </tr>
        </thead>
        <tbody>
            ${colorRows}
        </tbody>
    </table>
    
    <div class="harmony">
        <h2>🎨 Armonía de Paleta</h2>
        <div class="metric">
            <span><strong>Esquema de color:</strong></span>
            <span>${colorScheme}</span>
        </div>
        <div class="metric">
            <span><strong>Temperatura general:</strong></span>
            <span>${diagnosis.tempBalance}</span>
        </div>
        <div class="metric">
            <span><strong>Balance térmico:</strong></span>
            <span>${diagnosis.coolCount} fríos · ${diagnosis.warmCount} cálidos · ${diagnosis.neutralCount} neutros</span>
        </div>
        <div class="metric">
            <span><strong>Rango de luminosidad:</strong></span>
            <span>${diagnosis.lumaAssessment} (${(diagnosis.lumaRange.min * 100).toFixed(0)}% - ${(diagnosis.lumaRange.max * 100).toFixed(0)}%)</span>
        </div>
    </div>
    
    <div class="accessibility">
        <h2>♿ Accesibilidad Potencial</h2>
        <div class="metric">
            <span><strong>Combinaciones totales posibles:</strong></span>
            <span>${colors.length * (colors.length - 1)} (fondo × texto)</span>
        </div>
        <div class="metric">
            <span><strong>Combinaciones que pasan WCAG AA:</strong></span>
            <span>${accessibleCombos} (${((accessibleCombos / (colors.length * (colors.length - 1))) * 100).toFixed(0)}%)</span>
        </div>
        <div class="metric">
            <span><strong>Colores seguros para fondos:</strong></span>
            <span>${diagnosis.safeCount} de ${colors.length}</span>
        </div>
        ${diagnosis.problemCount > 0 ? `
        <div style="margin-top:15px;padding:12px;background:rgba(255,75,75,0.1);border-radius:6px;">
            <strong>⚠️ Advertencia:</strong> ${diagnosis.problemCount} colores de esta paleta no logran contraste WCAG AA con ningún texto estándar. 
            Si planeas usar estos colores en web, deberás ajustarlos (oscurecer o aclarar) o usarlos solo como acentos decorativos.
        </div>
        ` : `
        <div style="margin-top:15px;padding:12px;background:rgba(176,255,75,0.1);border-radius:6px;">
            <strong>✓ Excelente:</strong> Todos los colores de esta paleta son potencialmente utilizables con el texto correcto.
        </div>
        `}
    </div>
    
    <div style="background:#fff9e6;border-left:4px solid #ffcc00;padding:20px;margin:20px 0;border-radius:0 8px 8px 0;">
        <h2 style="margin-top:0;">💡 Recomendaciones para uso en web</h2>
        <ul style="margin:10px 0;padding-left:20px;">
            <li><strong>Color principal (${analyzed[0].hex}):</strong> Con ${analyzed[0].percentage.toFixed(1)}% de presencia, este es tu color dominante. 
                ${analyzed[0].wcagLevel === 'Ninguno' ? 'Necesita ajuste antes de usar como fondo de texto.' : `Úsalo con texto ${analyzed[0].bestTextColor === '#FFFFFF' ? 'blanco' : 'negro'} (ratio ${analyzed[0].bestContrast.toFixed(2)}:1).`}</li>
            ${analyzed.length > 1 ? `<li><strong>Color secundario (${analyzed[1].hex}):</strong> ${analyzed[1].percentage.toFixed(1)}% de presencia. 
                ${analyzed[1].wcagLevel === 'Ninguno' ? 'Considera usarlo solo para elementos no textuales.' : `Combina bien con texto ${analyzed[1].bestTextColor === '#FFFFFF' ? 'blanco' : 'negro'}.`}</li>` : ''}
            <li><strong>Contraste interno:</strong> ${accessibleCombos > colors.length ? `Puedes crear ${accessibleCombos} combinaciones accesibles entre estos colores.` : 'Considera agregar colores más claros u oscuros para mejorar versatilidad.'}</li>
            <li><strong>Siguiente paso:</strong> Carga esta paleta en el Auditor WCAG para ver la matriz completa de combinaciones y exportar código CSS/Tailwind.</li>
        </ul>
    </div>
    
    <div class="footer">
        ChromaAudit · Color Intelligence Platform<br>
        Generated on ${new Date().toLocaleDateString('es-MX')}
    </div>
</body>
</html>`;

    return report;
}

// ── EVENTOS DE BOTONES DE REPORTE ────────────────────────────────

document.getElementById('btn-report-url').addEventListener('click', () => {
    if (urlExtractedColors.length < 2) return;
    
    const sourceURL = document.getElementById('url-input').value.trim();
    const report = generateURLPaletteReport(urlExtractedColors, sourceURL);
    
    const blob = new Blob([report], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analisis-paleta-url-${Date.now()}.html`;
    a.click();
    URL.revokeObjectURL(url);
});

document.getElementById('btn-report-img').addEventListener('click', () => {
    if (imgExtractedColors.length < 2) return;
    
    const file = document.getElementById('img-file-input').files[0];
    const imageName = file ? file.name : 'imagen';
    
    // Reconstruir clusters con porcentajes
    const clusters = imgExtractedColors.map((hex, i) => {
        // Buscar en el DOM el porcentaje mostrado
        const swatches = document.querySelectorAll('#img-swatches .ext-swatch');
        let pct = 0;
        if (swatches[i]) {
            const pctEl = swatches[i].querySelector('.ext-swatch-pct');
            if (pctEl) {
                pct = parseFloat(pctEl.textContent);
            }
        }
        return { hex, pct };
    });
    
    const totalPixels = clusters.reduce((sum, c) => sum + c.pct, 0) || 100;
    
    const report = generateImagePaletteReport(clusters, totalPixels, imageName);
    
    const blob = new Blob([report], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analisis-paleta-${imageName.replace(/\.[^.]+$/, '')}-${Date.now()}.html`;
    a.click();
    URL.revokeObjectURL(url);
});

// Habilitar botones cuando hay colores
function updateReportButtons() {
    document.getElementById('btn-report-url').disabled = urlExtractedColors.length < 2;
    document.getElementById('btn-report-img').disabled = imgExtractedColors.length < 2;
}
</script>
</body>
</html>
